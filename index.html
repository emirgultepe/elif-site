<!doctype html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ELIF BEAUTY â€¢ GÃ¶nÃ¼l OnarÄ±m</title>
  <style>
    :root{
      --bg:#0b0b0c;
      --muted:#9b9ba3;
      --text:#f3f3f5;
      --line:#232327;
      --accent:#ffffff;
      --good:#55d6a7;
      --bad:#ff5c7a;
      --shadow: 0 16px 40px rgba(0,0,0,.45);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(1200px 800px at 20% -10%, rgba(255,255,255,.08), transparent 55%),
        radial-gradient(900px 700px at 90% 10%, rgba(255,255,255,.06), transparent 55%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
      overflow-x:hidden;
    }

    .topbar{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(10px);
      background: rgba(10,10,11,.75);
      border-bottom:1px solid var(--line);
    }
    .topbar-inner{
      max-width:980px;
      margin:0 auto;
      padding:14px 16px;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .logo{
      display:flex; align-items:center; gap:10px;
      font-weight:800;
      letter-spacing:.12em;
      text-transform:uppercase;
      user-select:none;
      white-space:nowrap;
    }
    .logo-badge{
      width:34px; height:34px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.25);
      display:grid; place-items:center;
      box-shadow: 0 10px 22px rgba(0,0,0,.35);
    }

    .actions{margin-left:auto; display:flex; gap:10px; align-items:center}
    .btn{
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      transition:.18s ease;
      font-weight:700;
      font-size:13px;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.32)}
    .btn.primary{background: var(--accent); color:#0b0b0c; border-color: rgba(255,255,255,.6);}
    .btn.danger{border-color: rgba(255,92,122,.35); background: rgba(255,92,122,.10);}
    .btn[disabled]{opacity:.45; cursor:not-allowed; transform:none !important;}

    .pill{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      color:rgba(255,255,255,.9);
      font-size:12px;
      display:flex; align-items:center; gap:8px;
      user-select:none;
    }
    .dot{width:7px; height:7px; border-radius:50%; background:var(--bad)}
    .dot.ok{background:var(--good)}
    .count{
      min-width:22px; height:22px;
      border-radius:999px;
      display:grid; place-items:center;
      background: rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.18);
      font-size:12px;
      padding:0 7px;
    }

    .wrap{max-width:980px; margin:0 auto; padding:16px;}
    .panel{
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.12);
      border-radius: var(--radius);
      padding:16px;
      box-shadow: var(--shadow);
    }
    .h1{margin:0 0 10px; font-size:22px;}
    .tiny{color:var(--muted); font-size:12px; line-height:1.5;}
    .divider{height:1px; background: var(--line); margin:14px 0}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px;}
    input, textarea{
      width:100%;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:12px 12px;
      outline:none;
      font-size:14px;
    }
    textarea{min-height:110px; resize:vertical}

    .grid{display:grid; grid-template-columns: repeat(2, 1fr); gap:12px; margin-top:14px;}
    @media (max-width:720px){ .grid{grid-template-columns:1fr} }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.12);
      border-radius: var(--radius);
      padding:14px;
      display:flex;
      gap:12px;
      align-items:flex-start;
    }
    .thumb{
      width:50px; height:50px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      display:grid; place-items:center;
      flex:0 0 auto;
      user-select:none;
    }
    .meta{flex:1}
    .name{font-weight:800; margin:0; font-size:14px;}
    .desc{margin:6px 0 10px; color:var(--muted); font-size:13px; line-height:1.5;}
    .tag{font-size:12px; color: rgba(255,255,255,.88); border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06); padding:6px 10px; border-radius:999px; white-space:nowrap;}
    .price{display:flex; align-items:center; justify-content:space-between; gap:10px;}

    .drawer{
      position:fixed; top:0; right:0;
      width:min(420px, 92vw); height:100%;
      background: rgba(12,12,13,.92);
      border-left:1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(10px);
      transform: translateX(110%);
      transition:.25s ease;
      z-index:100;
      display:flex; flex-direction:column;
      box-shadow: -20px 0 50px rgba(0,0,0,.5);
    }
    .drawer.open{transform: translateX(0)}
    .drawer-header{padding:16px; border-bottom:1px solid var(--line); display:flex; justify-content:space-between; gap:10px; align-items:center;}
    .drawer-header h3{margin:0; letter-spacing:.12em; text-transform:uppercase; font-size:14px;}
    .drawer-body{padding:14px 16px; overflow:auto; flex:1}
    .item{
      display:flex; align-items:flex-start; gap:10px;
      padding:12px; border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04); border-radius:16px; margin-bottom:10px;
    }
    .item .thumb{width:44px;height:44px;border-radius:14px}
    .remove{
      margin-left:auto;
      border:1px solid rgba(255,255,255,.18);
      background: transparent;
      color:rgba(255,255,255,.9);
      border-radius:999px;
      cursor:pointer;
      padding:6px 10px;
      font-size:12px;
      user-select:none;
    }
    .remove[disabled]{opacity:.45; cursor:not-allowed;}
    .drawer-footer{border-top:1px solid var(--line); padding:14px 16px; display:grid; gap:10px;}

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform: translateX(-50%);
      background: rgba(255,255,255,.92);
      color:#0b0b0c;
      padding:10px 12px;
      border-radius:999px;
      font-weight:800;
      font-size:13px;
      box-shadow: var(--shadow);
      display:none;
      z-index:300;
    }
    .toast.show{display:block; animation: pop .18s ease}
    @keyframes pop{
      from{transform:translateX(-50%) scale(.95);opacity:.2}
      to{transform:translateX(-50%) scale(1);opacity:1}
    }

    .roleOverlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.72);
      backdrop-filter: blur(6px);
      display:none; z-index:500;
      padding:18px;
      align-items:center; justify-content:center;
    }
    .roleOverlay.open{display:flex}
    .roleCard{
      width:min(520px, 96vw);
      background: rgba(12,12,13,.94);
      border:1px solid rgba(255,255,255,.14);
      border-radius:22px;
      box-shadow: var(--shadow);
      padding:16px;
    }
    .roleCard h3{
      margin:0 0 8px;
      letter-spacing:.10em;
      text-transform:uppercase;
      font-size:14px;
    }
    .roleGrid{display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;}
    @media (max-width:520px){ .roleGrid{grid-template-columns:1fr} }
    .roleBtn{
      border-radius:18px;
      padding:14px 12px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
      text-align:left;
      transition:.18s ease;
    }
    .roleBtn:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.32)}
    .roleBtn b{display:block; font-size:15px; margin-bottom:6px;}
    .roleBtn span{color:var(--muted); font-size:12px; line-height:1.4;}
    .miniLink{
      color:rgba(255,255,255,.85);
      font-size:12px;
      cursor:pointer;
      user-select:none;
      border-bottom:1px dashed rgba(255,255,255,.25);
    }

    .savedBadge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-size:12px;
      color: rgba(255,255,255,.9);
      user-select:none;
    }
    .savedBadge.ok{border-color: rgba(85,214,167,.35); background: rgba(85,214,167,.10);}

    .heart{position:fixed; font-size:18px; pointer-events:none; animation: floatUp 1.2s ease forwards; z-index:999;}
    @keyframes floatUp{from{transform:translateY(0) scale(1);opacity:1}to{transform:translateY(-120px) scale(1.35);opacity:0}}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="logo">
        <div class="logo-badge"><span>âœ¦</span></div>
        ELIF BEAUTY
      </div>

      <div class="actions">
        <div class="pill" id="statusPill"><span class="dot" id="dot"></span><span id="statusText">KÃ¼s Modu</span></div>
        <button class="btn" id="cartBtn">Sepet <span class="count" id="cartCount">0</span></button>
      </div>
    </div>
  </div>

  <main class="wrap">
    <div class="panel">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div class="h1">Sade Panel</div>
          <div class="tiny">
            <b id="whoText">Sen: -</b> â€¢ <span class="miniLink" id="changeRole">DeÄŸiÅŸtir</span>
          </div>
        </div>
        <div class="tiny" style="text-align:right;">
          <div id="lastSeenText">Son bakan: -</div>
          <div id="readText">Okundu: -</div>
          <div id="heartsText">Kalp: 0</div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="row">
        <button class="btn primary" id="btnPeace">BarÄ±ÅŸ</button>
        <button class="btn danger" id="btnKus">KÃ¼s</button>
        <button class="btn" id="sendLove">Kalp GÃ¶nder</button>
      </div>

      <div class="divider"></div>

      <label>Emirâ€™in kÄ±sa notu (sadece Emir)</label>
      <input id="kisaNot" placeholder="Ã¶rn: KonuÅŸmak istersen buradayÄ±m." />

      <label>Otomatik mesaj</label>
      <textarea id="mesaj" readonly></textarea>

      <div class="row" style="justify-content:space-between; margin-top:10px;">
        <button class="btn" id="copyBtn">Kopyala</button>
        <span class="tiny">Not: Linki paylaÅŸmayÄ±n.</span>
      </div>

      <div class="divider"></div>

      <label>Elifâ€™ten not (sadece Elif)</label>
      <textarea id="elifNote" placeholder="Elif buraya yazÄ±p GÃ¶nderâ€™e basabilirâ€¦"></textarea>
      <div class="row" style="justify-content:space-between; margin-top:10px;">
        <span class="savedBadge" id="noteState">-</span>
        <button class="btn primary" id="sendNote">GÃ¶nder</button>
      </div>
    </div>

    <div class="grid" id="grid"></div>
  </main>

  <aside class="drawer" id="drawer" aria-hidden="true">
    <div class="drawer-header">
      <h3>SEPET</h3>
      <button class="btn" id="closeDrawer">Kapat</button>
    </div>
    <div class="drawer-body" id="drawerBody"></div>
    <div class="drawer-footer">
      <div class="row" style="justify-content:space-between;">
        <span class="tiny" id="summary">0 Ã¼rÃ¼n</span>
        <button class="btn danger" id="clearBtn">BoÅŸalt (Elif)</button>
      </div>
    </div>
  </aside>

  <div class="toast" id="toast">âœ…</div>

  <div class="roleOverlay" id="roleOverlay">
    <div class="roleCard">
      <h3>Sen kimsin?</h3>
      <p class="tiny" style="margin:0;">Bu seÃ§im sadece bu cihazda hatÄ±rlanÄ±r.</p>
      <div class="roleGrid">
        <button class="roleBtn" id="pickEmir"><b>Ben Emirâ€™im</b><span>Not yazar, mesajÄ± kopyalar.</span></button>
        <button class="roleBtn" id="pickElif"><b>Ben Elifâ€™im</b><span>Not yazar, sepeti yÃ¶netir.</span></button>
      </div>
    </div>
  </div>

  <!-- FIREBASE -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, increment } from
      "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAYOjXNc0vfzNL68z4pmbX8kFoQSC11LZ8",
  authDomain: "elif-site.firebaseapp.com",
  projectId: "elif-site",
  storageBucket: "elif-site.firebasestorage.app",
  messagingSenderId: "740065601752",
  appId: "1:740065601752:web:38898a11ab28cba588cfad",
  measurementId: "G-53C6DN719D"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const stateRef = doc(db, "shared", "relationshipState");

    function nowTs(){ return Date.now(); }

    async function ensureDefaults(){
      const snap = await getDoc(stateRef);
      if(!snap.exists()){
        await setDoc(stateRef, {
          peaceMode: false,
          elifNote: "",
          elifNoteUpdatedAt: 0,
          emirNote: "",
          cart: [],
          hearts: 0,
          reads: {},
          lastSeen: {}
        });
      }
    }

    let lastPingAt = 0;
    async function pingSeenDebounced(name){
      const now = nowTs();
      if (now - lastPingAt < 5000) return;
      lastPingAt = now;
      await updateDoc(stateRef, { lastSeen: { name, ts: now } });
    }

    window.__sharedState = {
      viewerName: localStorage.getItem("viewerName") || "",

      setViewer(name){
        this.viewerName = name;
        localStorage.setItem("viewerName", name);
      },

      async init(handlers){
        await ensureDefaults();
        if (this.viewerName) await pingSeenDebounced(this.viewerName);

        onSnapshot(stateRef, (s)=>{
          if(!s.exists()) return;
          const d = s.data();
          handlers?.onState?.(d);
        });
      },

      async setPeaceMode(on){
        await updateDoc(stateRef, { peaceMode: !!on });
        if (this.viewerName) await pingSeenDebounced(this.viewerName);
      },

      async setElifNote(text){
        await updateDoc(stateRef, { elifNote: String(text ?? ""), elifNoteUpdatedAt: nowTs() });
        if (this.viewerName) await pingSeenDebounced(this.viewerName);
      },

      async setEmirNote(text){
        await updateDoc(stateRef, { emirNote: String(text ?? "") });
        if (this.viewerName) await pingSeenDebounced(this.viewerName);
      },

      async setCart(cartIds){
        await updateDoc(stateRef, { cart: cartIds });
        if (this.viewerName) await pingSeenDebounced(this.viewerName);
      },

      async addHearts(n=1){
        await updateDoc(stateRef, { hearts: increment(n) });
        if (this.viewerName) await pingSeenDebounced(this.viewerName);
      },

      async markRead(){
        if(!this.viewerName) return;
        await updateDoc(stateRef, { [`reads.${this.viewerName}`]: nowTs() });
        await pingSeenDebounced(this.viewerName);
      },

      async pingSeen(){
        if(!this.viewerName) return;
        await pingSeenDebounced(this.viewerName);
      }
    };
  </script>

  <!-- APP -->
  <script>
    const products = [
      { id:"p1", icon:"ðŸ¤", name:"Net Ã–zÃ¼r Serum", desc:"KÄ±sa ve net Ã¶zÃ¼r." },
      { id:"p2", icon:"ðŸ§ ", name:"AnlayÄ±ÅŸ Tonik", desc:"â€˜Seni anlÄ±yorumâ€™ modu." },
      { id:"p3", icon:"â˜•", name:"Kahve + YÃ¼rÃ¼yÃ¼ÅŸ", desc:"Somut telafi Ã¶nerisi." },
      { id:"p4", icon:"ðŸŽ§", name:"Dinleme Maskesi", desc:"SÃ¶zÃ¼nÃ¼ kesmeden dinle." },
      { id:"p5", icon:"ðŸ“µ", name:"BaskÄ±sÄ±z Alan", desc:"Alan tanÄ±, sakinleÅŸ." },
      { id:"p6", icon:"ðŸŽ", name:"KÃ¼Ã§Ã¼k SÃ¼rpriz", desc:"DÃ¼ÅŸÃ¼nceli jest." }
    ];

    const grid = document.getElementById("grid");
    const drawer = document.getElementById("drawer");
    const cartBtn = document.getElementById("cartBtn");
    const closeDrawer = document.getElementById("closeDrawer");
    const drawerBody = document.getElementById("drawerBody");
    const cartCount = document.getElementById("cartCount");
    const summary = document.getElementById("summary");
    const clearBtn = document.getElementById("clearBtn");

    const statusText = document.getElementById("statusText");
    const dot = document.getElementById("dot");
    const statusPill = document.getElementById("statusPill");
    const btnPeace = document.getElementById("btnPeace");
    const btnKus = document.getElementById("btnKus");

    const kisaNot = document.getElementById("kisaNot");
    const mesaj = document.getElementById("mesaj");
    const copyBtn = document.getElementById("copyBtn");

    const elifNoteEl = document.getElementById("elifNote");
    const sendNote = document.getElementById("sendNote");
    const noteState = document.getElementById("noteState");

    const heartsText = document.getElementById("heartsText");
    const lastSeenText = document.getElementById("lastSeenText");
    const readText = document.getElementById("readText");
    const whoText = document.getElementById("whoText");
    const changeRole = document.getElementById("changeRole");
    const sendLove = document.getElementById("sendLove");

    const toast = document.getElementById("toast");
    const roleOverlay = document.getElementById("roleOverlay");
    const pickEmir = document.getElementById("pickEmir");
    const pickElif = document.getElementById("pickElif");

    let cart = [];
    let suppressCartWrite = false;

    function viewer(){ return (window.__sharedState?.viewerName || ""); }
    function isEmir(){ return viewer() === "Emir"; }
    function isElif(){ return viewer() === "Elif"; }
    function canEditMode(){ return isEmir() || isElif(); } // ikiniz de
    function money(n){ return `${n}â‚º`; }

    function popToast(text="âœ…"){
      toast.textContent = text;
      toast.classList.add("show");
      setTimeout(()=>toast.classList.remove("show"), 1100);
    }
    function copyText(str){
      navigator.clipboard.writeText(str)
        .then(()=>popToast("KopyalandÄ± âœ…"))
        .catch(()=>popToast("KopyalanamadÄ± âŒ"));
    }

    function heart(x,y,emoji=â¤ï¸"){
      const h = document.createElement("div");
      h.className="heart";
      h.textContent = emoji;
      h.style.left = x + "px";
      h.style.top = y + "px";
      document.body.appendChild(h);
      setTimeout(()=>h.remove(), 1200);
    }
    function burstHearts(n=10){
      const cx = window.innerWidth - 80;
      const cy = 90;
      for(let i=0;i<n;i++){
        const x = cx + (Math.random()*40 - 20);
        const y = cy + (Math.random()*30 - 15);
        setTimeout(()=>heart(x,y, Math.random()>.25?"â¤ï¸":"ðŸ¤"), i*35);
      }
    }

    function openDrawer(){ drawer.classList.add("open"); drawer.setAttribute("aria-hidden","false"); }
    function closeDrawerFn(){ drawer.classList.remove("open"); drawer.setAttribute("aria-hidden","true"); }

    function renderPeaceUI(on){
      if(on){
        statusText.textContent = "BarÄ±ÅŸ Modu";
        dot.classList.add("ok");
        statusPill.style.borderColor = "rgba(85,214,167,.35)";
      } else {
        statusText.textContent = "KÃ¼s Modu";
        dot.classList.remove("ok");
        statusPill.style.borderColor = "rgba(255,255,255,.12)";
      }
    }

    async function setPeaceModeShared(on){
      renderPeaceUI(on);
      if (window.__sharedState && canEditMode()) {
        await window.__sharedState.setPeaceMode(on);
      }
    }

    function renderCards(){
      grid.innerHTML = "";
      products.forEach(p=>{
        const el = document.createElement("div");
        el.className="card";
        el.innerHTML = `
          <div class="thumb"><span>${p.icon}</span></div>
          <div class="meta">
            <p class="name">${p.name}</p>
            <p class="desc">${p.desc}</p>
            <div class="price">
              <span class="tag">${money(0)}</span>
              <button class="btn primary add" data-id="${p.id}">Ekle</button>
            </div>
          </div>
        `;
        grid.appendChild(el);
      });

      grid.querySelectorAll(".add").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          if(!isElif()) return; // sepet sadece Elif
          addToCart(btn.dataset.id);
        });
      });

      enforcePermissions();
    }

    function cartIds(){ return cart.map(p => p.id); }

    function addToCart(id){
      const p = products.find(x=>x.id===id);
      if(!p) return;
      cart.push(p);
      popToast("Sepete eklendi");
      updateCartUI();
      if (!suppressCartWrite && window.__sharedState) window.__sharedState.setCart(cartIds());
    }

    function removeFromCart(idx){
      if(!isElif()) return;
      cart.splice(idx,1);
      updateCartUI();
      if (!suppressCartWrite && window.__sharedState) window.__sharedState.setCart(cartIds());
    }

    function applyRemoteCart(ids){
      suppressCartWrite = true;
      cart = ids.map(id => products.find(p => p.id===id)).filter(Boolean);
      updateCartUI();
      suppressCartWrite = false;
    }

    function updateCartUI(){
      cartCount.textContent = cart.length;
      drawerBody.innerHTML = "";
      summary.textContent = `${cart.length} Ã¼rÃ¼n`;

      if(cart.length === 0){
        drawerBody.innerHTML = `<p class="tiny">Sepet boÅŸ.</p>`;
        enforcePermissions();
        return;
      }

      cart.forEach((p, idx)=>{
        const it = document.createElement("div");
        it.className="item";
        it.innerHTML = `
          <div class="thumb"><span>${p.icon}</span></div>
          <div style="flex:1">
            <div class="name">${p.name}</div>
            <div class="tiny">${p.desc}</div>
          </div>
          <button class="remove" data-idx="${idx}">Sil</button>
        `;
        drawerBody.appendChild(it);
      });

      drawerBody.querySelectorAll(".remove").forEach(btn=>{
        btn.addEventListener("click", ()=> removeFromCart(Number(btn.dataset.idx)));
      });

      enforcePermissions();
    }

    function buildMessage(emirNote){
      const note = (emirNote || "").trim();
      const parts = [];
      parts.push("Elif,");
      parts.push("Seni Ã¼zdÃ¼ysem gerÃ§ekten Ã¶zÃ¼r dilerim. Savunmaya geÃ§mek istemiyorum.");
      parts.push("KonuÅŸmak istersen ben buradayÄ±m. Seni Ã¶nemsiyorum. ðŸ¤");
      if(note) parts.push(note);
      return parts.join("\n\n");
    }

    function setNoteBadge(text){
      if(text){
        noteState.textContent = "GÃ¶nderildi âœ…";
        noteState.classList.add("ok");
      } else {
        noteState.textContent = "-";
        noteState.classList.remove("ok");
      }
    }

    function enforcePermissions(){
      whoText.textContent = `Sen: ${viewer() || "-"}`;

      // Mode: Emir + Elif
      const canMode = canEditMode();
      btnPeace.disabled = !canMode;
      btnKus.disabled = !canMode;

      // Emir notu: sadece Emir yazsÄ±n
      kisaNot.disabled = !isEmir();

      // Elif notu + sepet: sadece Elif
      elifNoteEl.readOnly = !isElif();
      sendNote.disabled = !isElif();
      clearBtn.disabled = !isElif();

      document.querySelectorAll(".add").forEach(b => b.disabled = !isElif());
      document.querySelectorAll(".remove").forEach(b => b.disabled = !isElif());
    }

    function openRoleOverlay(){ roleOverlay.classList.add("open"); }
    function closeRoleOverlay(){ roleOverlay.classList.remove("open"); }

    async function setRole(name){
      window.__sharedState?.setViewer(name);
      enforcePermissions();
      closeRoleOverlay();
      if(window.__sharedState){
        await window.__sharedState.markRead();
        await window.__sharedState.pingSeen();
      }
    }

    // Events
    cartBtn.addEventListener("click", openDrawer);
    closeDrawer.addEventListener("click", closeDrawerFn);

    clearBtn.addEventListener("click", ()=>{
      if(!isElif()) return;
      cart = [];
      updateCartUI();
      popToast("Sepet boÅŸaltÄ±ldÄ±");
      if (window.__sharedState) window.__sharedState.setCart([]);
    });

    btnPeace.addEventListener("click", async ()=>{
      if(!canEditMode()) return;
      await setPeaceModeShared(true);
      popToast("BarÄ±ÅŸ âœ…");
    });

    btnKus.addEventListener("click", async ()=>{
      if(!canEditMode()) return;
      await setPeaceModeShared(false);
      popToast("KÃ¼s âœ…");
    });

    sendLove.addEventListener("click", async ()=>{
      burstHearts(12);
      popToast("Kalp ðŸ’Œ");
      if(window.__sharedState) await window.__sharedState.addHearts(1);
    });

    copyBtn.addEventListener("click", ()=> copyText(mesaj.value));

    // Emir note sync (debounce)
    let emirTimer = null;
    kisaNot.addEventListener("input", ()=>{
      if(!isEmir()) return;
      mesaj.value = buildMessage(kisaNot.value);
      if(!window.__sharedState) return;
      clearTimeout(emirTimer);
      emirTimer = setTimeout(()=> window.__sharedState.setEmirNote(kisaNot.value), 250);
    });

    // Elif note send
    sendNote.addEventListener("click", async ()=>{
      if(!isElif()) return;
      if(!window.__sharedState) return;
      await window.__sharedState.setElifNote(elifNoteEl.value);
      setNoteBadge(elifNoteEl.value.trim());
      popToast("Not gÃ¶nderildi âœ…");
    });

    // Role overlay
    changeRole.addEventListener("click", openRoleOverlay);
    pickEmir.addEventListener("click", ()=> setRole("Emir"));
    pickElif.addEventListener("click", ()=> setRole("Elif"));

    // Read status: smart
    async function markReadSmart(){
      if(!window.__sharedState) return;
      if(!viewer()) return;
      await window.__sharedState.markRead();
    }
    window.addEventListener("load", ()=> markReadSmart());
    document.addEventListener("visibilitychange", ()=>{
      if(document.visibilityState === "visible") markReadSmart();
    });
    window.addEventListener("focus", ()=> markReadSmart());

    // Init
    renderCards();
    updateCartUI();
    mesaj.value = buildMessage("");

    if(!window.__sharedState?.viewerName) openRoleOverlay();
    else enforcePermissions();

    // Firebase live
    (async ()=>{
      if(!window.__sharedState) return;

      await window.__sharedState.init({
        onState: (d)=>{
          renderPeaceUI(!!d.peaceMode);
          heartsText.textContent = `Kalp: ${d.hearts ?? 0}`;

          const fmt = (ts)=> ts ? new Date(ts).toLocaleString("tr-TR") : "-";
          readText.textContent = `Okundu â€¢ Emir: ${fmt(d.reads?.Emir)} â€¢ Elif: ${fmt(d.reads?.Elif)}`;

          if(d.lastSeen?.name && d.lastSeen?.ts){
            lastSeenText.textContent = `Son bakan: ${d.lastSeen.name} â€¢ ${fmt(d.lastSeen.ts)}`;
          } else {
            lastSeenText.textContent = "Son bakan: -";
          }

          // Emir note -> message
          if(!isEmir()){
            // Emir deÄŸilse kendi inputunu deÄŸiÅŸtirmeyelim; ama mesajÄ± gÃ¼ncelleyelim
            mesaj.value = buildMessage(d.emirNote || "");
          } else {
            // Emir ise input senin kontrolÃ¼nde; remote emirNote gelirse (baÅŸka cihaz) senkronla
            if(kisaNot.value !== (d.emirNote || "")) kisaNot.value = d.emirNote || "";
            mesaj.value = buildMessage(kisaNot.value);
          }

          // Elif note
          if(!isElif()){
            elifNoteEl.value = d.elifNote || "";
          }
          setNoteBadge((d.elifNote || "").trim());

          // Cart
          const ids = Array.isArray(d.cart) ? d.cart : [];
          const local = cartIds();
          const same = local.length === ids.length && local.every((x,i)=>x===ids[i]);
          if(!same) applyRemoteCart(ids);

          enforcePermissions();
        }
      });

      await window.__sharedState.pingSeen();
      await window.__sharedState.markRead();
    })();
  </script>
</body>
</html>
