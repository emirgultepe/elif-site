<!doctype html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ELIF & EMIR ‚Ä¢ Private Space</title>
  <style>
    :root{
      /* Tasarƒ±m Renkleri (Dark/Luxe) */
      --bg:#000000; 
      --card: #111111; 
      --line: #333333;
      --text:#ffffff; 
      --muted:#888888; 
      --good:#10b981; 
      --bad:#ef4444;  
      --accent: #db2777; 
      --r:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: 'Montserrat', ui-sans-serif, system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    
    /* √úst Bar */
    .top{position:sticky; top:0; z-index:20; backdrop-filter: blur(12px); background: rgba(0,0,0,.8); border-bottom:1px solid var(--line);}
    .topin{max-width:980px; margin:0 auto; padding:16px; display:flex; align-items:center; gap:12px;}
    .brand{display:flex; align-items:center; gap:10px; font-weight:900; letter-spacing:.15em; font-size: 1.2rem; text-transform:uppercase; user-select:none;}
    .brand span { color: var(--accent); font-weight: 300; font-style: italic; }
    
    .right{margin-left:auto; display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end;}
    .chip{padding:6px 12px; border-radius:4px; border:1px solid var(--line); background: #1a1a1a; font-size:11px; font-weight: 600; color:#fff; display:flex; align-items:center; gap:6px; user-select:none; white-space:nowrap; letter-spacing: 0.05em;}
    .dot{width:8px; height:8px; border-radius:50%; background:var(--bad); box-shadow: 0 0 10px var(--bad);} 
    .dot.ok{background:var(--good); box-shadow: 0 0 10px var(--good);}
    
    .link{font-size:11px; color:var(--muted); text-decoration: underline; cursor:pointer;}
    .count{min-width:18px; height:18px; border-radius:999px; display:flex; align-items:center; justify-content: center; background: var(--accent); color: white; font-size:10px; font-weight: bold; margin-left: 5px;}

    .wrap{max-width:980px; margin:0 auto; padding:16px;}
    .card{background: var(--card); border:1px solid var(--line); border-radius: var(--r); padding:20px; margin-top:20px;}
    .title{margin:0 0 8px; font-size:16px; text-transform: uppercase; letter-spacing: 0.1em; border-left: 3px solid var(--accent); padding-left: 10px;}
    .muted{color:var(--muted); font-size:13px; line-height:1.5; margin:0;}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .divider{height:1px; background:var(--line); margin:20px 0}

    /* Butonlar */
    .btn{border:1px solid var(--line); background: #000; color:#fff; padding:12px 20px; border-radius:0; cursor:pointer; font-weight:700; font-size:12px; text-transform: uppercase; letter-spacing: 0.1em; transition:.2s ease;}
    .btn:hover{background: var(--line);}
    .btn.primary{ background: var(--good); color: #fff; border-color: var(--good); }
    .btn.primary:hover{ background: #059669; }
    .btn.danger{ background: var(--bad); color: #fff; border-color: var(--bad); }
    .btn.danger:hover{ background: #dc2626; }
    
    label{display:block; font-size:11px; font-weight: bold; text-transform: uppercase; color:var(--muted); margin:15px 0 8px; letter-spacing: 0.05em;}
    
    textarea{
      width:100%;
      border-radius:4px;
      border:1px solid var(--line);
      background: #111;
      color: #ddd;
      padding:15px;
      outline:none;
      font-size:14px;
      line-height: 1.6;
      min-height:150px;
      resize:vertical;
      font-family: monospace;
    }
    textarea:focus { border-color: var(--accent); }
    textarea[readonly]{opacity:.5; cursor: not-allowed;}

    .grid{display:grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap:15px; margin-top:15px;}
    
    .pCard{
        border:1px solid var(--line); background: #000; padding:15px; display:flex; flex-direction: column; align-items: center; text-align: center; transition: transform 0.2s;
    }
    .pCard:hover { transform: translateY(-5px); border-color: var(--accent); }
    .thumb{font-size: 40px; margin-bottom: 10px;}
    .name{font-weight:700; margin:5px 0; font-size:13px;}
    .desc{margin:5px 0 15px; color:var(--muted); font-size:11px;}
    .tag{font-size:10px; color: #000; background: #fff; padding:2px 6px; font-weight: bold; text-transform: uppercase; margin-bottom: 5px;}

    /* Sepet */
    .drawer{position:fixed; top:0; right:0; width:min(400px, 85vw); height:100%; background: #000; border-left:1px solid var(--line); transform: translateX(110%); transition:.3s cubic-bezier(0.4, 0, 0.2, 1); z-index:100; display:flex; flex-direction:column; box-shadow: -10px 0 50px rgba(0,0,0,.8);}
    .drawer.open{transform: translateX(0)}
    .drawer-header{padding:20px; border-bottom:1px solid var(--line); display:flex; justify-content:space-between; align-items:center;}
    .drawer-header h3{margin:0; letter-spacing:.1em; text-transform:uppercase; font-size:16px;}
    .drawer-body{padding:20px; overflow:auto; flex:1}
    .item{display:flex; align-items:center; gap:15px; padding:10px; border-bottom:1px solid var(--line); margin-bottom:10px;}
    .xbtn{margin-left:auto; background: transparent; border: none; color: var(--muted); cursor: pointer; font-size: 18px;}
    .xbtn:hover { color: var(--bad); }
    .drawer-footer{border-top:1px solid var(--line); padding:20px; display:grid; gap:10px;}

    /* Modal */
    .overlay{position:fixed; inset:0; background: #000; z-index:500; display:none; align-items:center; justify-content:center; padding:20px;}
    .overlay.open{display:flex}
    .modal{width:min(450px, 96vw); text-align: center;}
    .modal h3{margin:0 0 30px; font-size:24px; letter-spacing:.2em; text-transform:uppercase; font-weight: 300;}
    
    /* Rol Se√ßim Alanƒ± */
    .role-container { display:flex; justify-content: center; gap:30px; margin-top:20px; }
    
    .roleBtn{
        background: #111;
        border: 1px solid var(--line); 
        color:var(--text); 
        cursor:pointer; 
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        justify-content: center;
        gap: 10px; 
        padding: 30px;
        border-radius: var(--r);
        width: 140px;
        transition: .3s;
    }
    .roleBtn:hover { transform: scale(1.05); border-color: var(--text); background: #222; }
    .roleBtn.elif:hover { border-color: var(--accent); box-shadow: 0 0 20px rgba(219, 39, 119, 0.3); }
    .roleBtn.emir:hover { border-color: #3b82f6; box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); }

    .roleBtn b{display:block; font-size:18px; letter-spacing: 0.1em;}
    .roleBtn span{color:var(--muted); font-size:12px; font-style: italic;}

    /* ≈ûifre Alanƒ± (Ba≈ülangƒ±√ßta gizli) */
    .pass-container { display:none; flex-direction: column; align-items: center; gap:15px; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }
    
    .passInput {
        background: #111;
        border: 1px solid var(--line);
        color: #fff;
        padding: 15px;
        text-align: center;
        letter-spacing: 5px;
        font-size: 20px;
        width: 200px;
        border-radius: 4px;
        outline: none;
    }
    .passInput:focus { border-color: var(--accent); }
    
    .backBtn { background:none; border:none; color:var(--muted); font-size:12px; text-decoration:underline; cursor:pointer; margin-top:10px; }

    .pill{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:4px; background: #222; font-size:10px; color: #aaa; text-transform: uppercase; font-weight: bold;}
    .pill.ok{color: var(--good); background: rgba(16, 185, 129, 0.1);}

    .toast{position:fixed; left:50%; bottom:30px; transform:translateX(-50%); background: #fff; color:#000; padding:12px 24px; font-weight:700; font-size:12px; letter-spacing: 0.05em; text-transform: uppercase; display:none; z-index:900;}
    .toast.show{display:block; animation: fadeUp 0.3s forwards;}

    @keyframes fadeUp { from { opacity: 0; transform: translate(-50%, 10px); } to { opacity: 1; transform: translate(-50%, 0); } }
    
    .heart{position:fixed; font-size:24px; pointer-events:none; animation: floatUp 1.5s ease forwards; z-index:999;}
    @keyframes floatUp{from{ transform: translateY(0) scale(1); opacity:1 }to{ transform: translateY(-150px) scale(1.5); opacity:0 }}
  </style>
</head>

<body>
  <div class="top">
    <div class="topin">
      <div class="brand">ELIF<span style="color:#db2777">BEAUTY</span></div>
      <div class="right">
        <div class="chip"><span class="dot" id="modeDot"></span><span id="modeText">K√ºs</span></div>
        <div class="chip">‚è± <span id="timerText">0 sn</span></div>
        <button class="btn" id="cartOpenBtn">Sepet <span class="count" id="cartCount">0</span></button>
        <div class="chip" style="background:transparent; border:none;">
            <span id="whoText" style="font-size:10px; color:#666;">-</span> 
            <span class="link" id="changeRole" style="margin-left:5px;">√áƒ±kƒ±≈ü</span>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <h2 class="title">ƒ∞li≈üki Durumu</h2>
      <div class="row" style="margin-bottom: 20px;">
        <button class="btn primary" id="btnPeace" style="flex:1;">ü§ç Barƒ±≈ütƒ±k</button>
        <button class="btn danger" id="btnKus" style="flex:1;">‚õàÔ∏è K√ºs√ºz</button>
      </div>
      
      <div class="row" style="justify-content: space-between; border-top: 1px solid var(--line); padding-top: 15px;">
         <button class="btn" id="sendHeart" style="border-radius: 50%; width: 50px; height: 50px; padding:0; font-size: 20px; border-color: var(--accent); color: var(--accent);">üíñ</button>
         <div style="text-align: right;">
            <div style="font-size: 10px; color: #666; margin-bottom: 4px;">KALP SAYACI</div>
            <span class="pill" id="heartsPill" style="font-size: 14px; color: #fff;">0</span>
         </div>
      </div>
      
      <div style="margin-top: 15px; font-size: 10px; color: #444; text-align: center;">
        <span id="lastSeenPill">Son aktivite: -</span> | <span id="readPill">Okundu: -</span>
      </div>
    </div>

    <div class="card">
      <h2 class="title">√ñzel Notlar</h2>
      
      <label style="color: #3b82f6;">EMƒ∞R'ƒ∞N SATIRLARI</label>
      <textarea id="emirNote" placeholder="Emir buraya duygularƒ±nƒ± yazacak..."></textarea>
      <div class="row" style="justify-content:space-between; margin-top:5px; margin-bottom: 20px;">
        <button class="link" id="copyEmir" style="background:none; border:none; padding:0;">Kopyala</button>
        <span class="pill" id="emirSavedPill">Senkron: -</span>
      </div>

      <div class="divider"></div>

      <label style="color: #db2777;">ELƒ∞F'ƒ∞N SATIRLARI</label>
      <textarea id="elifNote" placeholder="Elif buraya duygularƒ±nƒ± yazacak..."></textarea>
      <div class="row" style="justify-content:flex-end; margin-top:5px;">
        <span class="pill" id="elifSavedPill">Senkron: -</span>
      </div>
    </div>

    <div class="card">
      <h2 class="title">Telafi Koleksiyonu</h2>
      <p class="muted">G√∂n√ºl almak i√ßin se√ßilmi≈ü √∂zel "√ºr√ºnler".</p>
      <div class="grid" id="grid"></div>
    </div>
  </div>

  <aside class="drawer" id="drawer" aria-hidden="true">
    <div class="drawer-header">
      <h3>SEPETƒ∞M</h3>
      <button class="xbtn" id="cartCloseBtn">√ó</button>
    </div>
    <div class="drawer-body" id="drawerBody"></div>
    <div class="drawer-footer">
      <div class="row" style="justify-content:space-between; align-items: center;">
        <span class="muted" id="cartSummary">0 √ºr√ºn</span>
        <button class="btn danger" id="clearCartBtn" style="font-size: 10px; padding: 8px 12px;">Sepeti Bo≈üalt</button>
      </div>
      <button class="btn primary" style="width:100%; margin-top:10px;">ONAYLA ‚ù§Ô∏è</button>
    </div>
  </aside>

  <div class="toast" id="toast">‚úÖ</div>

  <div class="overlay" id="overlay">
    <div class="modal">
      <h3 id="modalTitle">Kƒ∞M Gƒ∞Rƒ∞≈û YAPIYOR?</h3>
      
      <div class="role-container" id="roleContainer">
        <button class="roleBtn emir" id="pickEmir">
            <b>EMƒ∞R</b>
            <span>"A≈üƒ±k"</span>
        </button>

        <button class="roleBtn elif" id="pickElif">
            <b>ELƒ∞F</b>
            <span>"Prenses"</span>
        </button>
      </div>

      <div class="pass-container" id="passContainer">
        <div style="font-size: 14px; margin-bottom: 10px; color: #888;" id="passHint">L√ºtfen parolayƒ± giriniz</div>
        <input type="password" id="passInput" class="passInput" maxlength="10">
        <button class="btn primary" id="btnUnlock" style="width: 200px; margin-top: 10px;">Gƒ∞Rƒ∞≈û YAP</button>
        <button class="backBtn" id="btnBack">‚Üê Geri D√∂n</button>
      </div>

    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, increment } from 
      "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // üî¥ KENDƒ∞ FIREBASE Bƒ∞LGƒ∞LERƒ∞Nƒ∞ BURAYA YAPI≈ûTIRMAYI UNUTMA üî¥
    const firebaseConfig = {
       apiKey: "AIzaSyAYOjXNc0vfzNL68z4pmbX8kFoQSC11LZ8",
  authDomain: "elif-site.firebaseapp.com",
  projectId: "elif-site",
  storageBucket: "elif-site.firebasestorage.app",
  messagingSenderId: "740065601752",
  appId: "1:740065601752:web:38898a11ab28cba588cfad",
  measurementId: "G-53C6DN719D"
    };

    // ----- UI Elements -----
    const overlay = document.getElementById("overlay");
    const roleContainer = document.getElementById("roleContainer");
    const passContainer = document.getElementById("passContainer");
    const modalTitle = document.getElementById("modalTitle");
    const passInput = document.getElementById("passInput");
    const passHint = document.getElementById("passHint");
    const btnUnlock = document.getElementById("btnUnlock");
    const btnBack = document.getElementById("btnBack");

    const pickEmir = document.getElementById("pickEmir");
    const pickElif = document.getElementById("pickElif");
    
    const whoText = document.getElementById("whoText");
    const changeRole = document.getElementById("changeRole");

    const modeDot = document.getElementById("modeDot");
    const modeText = document.getElementById("modeText");
    const timerText = document.getElementById("timerText");
    const btnPeace = document.getElementById("btnPeace");
    const btnKus = document.getElementById("btnKus");

    const sendHeart = document.getElementById("sendHeart");
    const heartsPill = document.getElementById("heartsPill");
    const lastSeenPill = document.getElementById("lastSeenPill");
    const readPill = document.getElementById("readPill");

    const emirNoteEl = document.getElementById("emirNote");
    const elifNoteEl = document.getElementById("elifNote");
    const emirSavedPill = document.getElementById("emirSavedPill");
    const elifSavedPill = document.getElementById("elifSavedPill");
    const copyEmir = document.getElementById("copyEmir");

    const grid = document.getElementById("grid");

    const drawer = document.getElementById("drawer");
    const cartOpenBtn = document.getElementById("cartOpenBtn");
    const cartCloseBtn = document.getElementById("cartCloseBtn");
    const drawerBody = document.getElementById("drawerBody");
    const cartCount = document.getElementById("cartCount");
    const cartSummary = document.getElementById("cartSummary");
    const clearCartBtn = document.getElementById("clearCartBtn");

    const toast = document.getElementById("toast");

    // ----- √úr√ºn Listesi -----
    const products = [
      { id:"p1", icon:"‚ú®", name:"Samimi √ñz√ºr Serum", tag:"Best Seller", desc:"%100 saf pi≈ümanlƒ±k i√ßerir." },
      { id:"p2", icon:"üíñ", name:"Sonsuz ƒ∞lgi Maskesi", tag:"Limited", desc:"7/24 kesintisiz ilgi saƒülar." },
      { id:"p3", icon:"üç´", name:"√áikolata & Kahve Seti", tag:"Classic", desc:"Mutluluk hormonu takviyesi." },
      { id:"p4", icon:"üëÇ", name:"Aktif Dinleme Tonik", tag:"Essential", desc:"S√∂z kesmeden dinleme √∂zelliƒüi." },
      { id:"p5", icon:"üß∏", name:"Sarƒ±lma Terapisi", tag:"Cozy", desc:"Anƒ±nda sakinle≈ütirici etki." },
      { id:"p6", icon:"üåπ", name:"Romantik Ak≈üam Yemeƒüi", tag:"Exclusive", desc:"Rezervasyon ve √ßi√ßek dahil." },
    ];

    // ----- Yardƒ±mcƒ± Fonksiyonlar -----
    const nowTs = () => Date.now();
    const fmtTR = (ts) => ts ? new Date(ts).toLocaleTimeString("tr-TR", {hour:'2-digit', minute:'2-digit'}) : "-";

    function popToast(text="‚úÖ"){
      toast.textContent = text;
      toast.classList.add("show");
      setTimeout(()=>toast.classList.remove("show"), 2000);
    }
    function copyText(str){
      navigator.clipboard.writeText(str)
        .then(()=>popToast("NOT KOPYALANDI"))
        .catch(()=>popToast("Kopyalanamadƒ±"));
    }
    function heart(x,y,emoji="‚ù§Ô∏è"){
      const h = document.createElement("div");
      h.className="heart";
      h.textContent = emoji;
      h.style.left = x + "px";
      h.style.top = y + "px";
      document.body.appendChild(h);
      setTimeout(()=>h.remove(), 1200);
    }
    function burstHearts(n=12){
      const cx = window.innerWidth / 2;
      const cy = window.innerHeight / 2;
      for(let i=0;i<n;i++){
        const x = cx + (Math.random()*100 - 50);
        const y = cy + (Math.random()*100 - 50);
        setTimeout(()=>heart(x,y, Math.random()>.5?"üíñ":"ü§ç"), i*50);
      }
    }
    function openDrawer(){ drawer.classList.add("open"); drawer.setAttribute("aria-hidden","false"); }
    function closeDrawer(){ drawer.classList.remove("open"); drawer.setAttribute("aria-hidden","true"); }

    function formatDuration(ms){
      if(ms < 0) ms = 0;
      const s = Math.floor(ms/1000);
      const days = Math.floor(s/86400);
      const hrs  = Math.floor((s%86400)/3600);
      const mins = Math.floor((s%3600)/60);
      const secs = s%60;
      const parts = [];
      if(days) parts.push(`${days}g`);
      if(hrs || days) parts.push(`${hrs}sa`);
      if(mins || hrs || days) parts.push(`${mins}dk`);
      parts.push(`${secs}sn`);
      return parts.join(" ");
    }
    function renderMode(isPeace){
      if(isPeace){ modeText.textContent = "BARI≈ûTIK"; modeDot.classList.add("ok"); }
      else { modeText.textContent = "K√úS√úZ"; modeDot.classList.remove("ok"); }
    }
    function setPill(el, text, ok=false){
      el.textContent = text;
      el.classList.toggle("ok", ok);
    }

    // ----- Rol ve ≈ûifre Y√∂netimi -----
    let selectedRole = null;
    
    // ≈ûifreler (Daha g√ºvenli olmasƒ± i√ßin normalde backend'de tutulur ama bu basit projede burada)
    const PASSWORDS = {
        "Emir": "615127",
        "Elif": "6161221"
    };

    function viewer(){ return localStorage.getItem("viewerName") || ""; }
    function isEmir(){ return viewer() === "Emir"; }
    function isElif(){ return viewer() === "Elif"; }

    function setViewer(name){
      localStorage.setItem("viewerName", name);
      whoText.textContent = name;
      overlay.classList.remove("open");
      resetModal();
      enforcePermissions();
    }
    
    function resetModal(){
        roleContainer.style.display = "flex";
        passContainer.style.display = "none";
        modalTitle.textContent = "Kƒ∞M Gƒ∞Rƒ∞≈û YAPIYOR?";
        passInput.value = "";
        selectedRole = null;
    }

    function showPassInput(role){
        selectedRole = role;
        roleContainer.style.display = "none";
        passContainer.style.display = "flex";
        modalTitle.textContent = role + " ƒ∞√áƒ∞N Gƒ∞Rƒ∞≈û";
        passHint.textContent = `${role} i√ßin parolanƒ± gir:`;
        passInput.focus();
    }
    
    function checkPass(){
        const val = passInput.value;
        if(PASSWORDS[selectedRole] && val === PASSWORDS[selectedRole]){
            setViewer(selectedRole);
            markRead().catch(()=>{});
        } else {
            passInput.value = "";
            popToast("HATALI PAROLA üîí");
            passInput.style.borderColor = "red";
            setTimeout(()=> passInput.style.borderColor = "#333", 1000);
        }
    }

    function openOverlay(){ 
        overlay.classList.add("open"); 
        resetModal();
    }

    // Modal Eventleri
    pickEmir.addEventListener("click", ()=> showPassInput("Emir"));
    pickElif.addEventListener("click", ()=> showPassInput("Elif"));
    
    btnBack.addEventListener("click", resetModal);
    
    btnUnlock.addEventListener("click", checkPass);
    passInput.addEventListener("keypress", (e)=>{
        if(e.key === "Enter") checkPass();
    });

    function enforcePermissions(){
      emirNoteEl.readOnly = !isEmir();
      elifNoteEl.readOnly = !isElif();
      copyEmir.disabled = !isEmir();
      
      if(isEmir()) emirNoteEl.placeholder = "Yazabilirsin Emir...";
      else emirNoteEl.placeholder = "Emir'in yazmasƒ±nƒ± bekle...";
      
      if(isElif()) elifNoteEl.placeholder = "Yazabilirsin Prenses...";
      else elifNoteEl.placeholder = "Elif'in yazmasƒ±nƒ± bekle...";
    }

    // ----- Firestore Logic -----
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const stateRef = doc(db, "shared", "relationshipState");

    async function ensureDefaults(){
      const snap = await getDoc(stateRef);
      if(!snap.exists()){
        await setDoc(stateRef, {
          peaceMode: false,
          modeChangedAt: nowTs(),
          emirNote: "",
          elifNote: "",
          emirNoteUpdatedAt: 0,
          elifNoteUpdatedAt: 0,
          cart: [],
          hearts: 0,
          reads: {},
          lastSeen: {}
        });
      }
    }

    let lastPingAt = 0;
    async function pingSeenDebounced(name){
      const now = nowTs();
      if(now - lastPingAt < 5000) return;
      lastPingAt = now;
      await updateDoc(stateRef, { lastSeen: { name, ts: now } });
    }

    async function markRead(){
      const v = viewer();
      if(!v) return;
      await updateDoc(stateRef, { [`reads.${v}`]: nowTs() });
      await pingSeenDebounced(v);
    }

    // ----- Not Kaydetme (Otomatik) -----
    let emirTimer = null;
    let elifTimer = null;

    let emirTyping = false;
    let elifTyping = false;
    emirNoteEl.addEventListener("focus", ()=>{ emirTyping = true; });
    emirNoteEl.addEventListener("blur", ()=>{ emirTyping = false; });
    elifNoteEl.addEventListener("focus", ()=>{ elifTyping = true; });
    elifNoteEl.addEventListener("blur", ()=>{ elifTyping = false; });

    async function saveEmirNote(val){
      setPill(emirSavedPill, "Kaydediliyor...", false);
      await updateDoc(stateRef, { emirNote: String(val||""), emirNoteUpdatedAt: nowTs() });
      setPill(emirSavedPill, "Kaydedildi ‚úÖ", true);
      const v = viewer(); if(v) await pingSeenDebounced(v);
    }

    async function saveElifNote(val){
      setPill(elifSavedPill, "Kaydediliyor...", false);
      await updateDoc(stateRef, { elifNote: String(val||""), elifNoteUpdatedAt: nowTs() });
      setPill(elifSavedPill, "Kaydedildi ‚úÖ", true);
      const v = viewer(); if(v) await pingSeenDebounced(v);
    }

    emirNoteEl.addEventListener("input", ()=>{
      if(!isEmir()) return;
      clearTimeout(emirTimer);
      emirTimer = setTimeout(()=> saveEmirNote(emirNoteEl.value).catch(()=>{}), 500);
    });

    elifNoteEl.addEventListener("input", ()=>{
      if(!isElif()) return;
      clearTimeout(elifTimer);
      elifTimer = setTimeout(()=> saveElifNote(elifNoteEl.value).catch(()=>{}), 500);
    });

    copyEmir.addEventListener("click", ()=>{
      copyText(emirNoteEl.value || "");
    });

    // ----- Sepet Mantƒ±ƒüƒ± -----
    let cart = [];
    let suppressCartWrite = false;

    function normalizeCart(remoteCart){
      if(!Array.isArray(remoteCart)) return [];
      return remoteCart
        .filter(x => x && typeof x.id === "string")
        .map(x => ({ id:x.id, by: String(x.by||"?"), ts: Number(x.ts||0) }));
    }
    
    async function writeCart(){
      if(suppressCartWrite) return;
      await updateDoc(stateRef, { cart });
      const v = viewer(); if(v) await pingSeenDebounced(v);
    }

    function addToCart(id){
      const v = viewer() || "Biri";
      cart.push({ id, by: v, ts: nowTs() });
      updateCartUI();
      burstHearts(5);
      popToast("Sepete Eklendi");
      writeCart().catch(()=>{});
    }
    function removeFromCart(idx){
      cart.splice(idx,1);
      updateCartUI();
      writeCart().catch(()=>{});
    }

    function updateCartUI(){
      cartCount.textContent = String(cart.length);
      cartSummary.textContent = `${cart.length} √ºr√ºn var`;
      drawerBody.innerHTML = "";

      if(cart.length === 0){
        drawerBody.innerHTML = `<p class="muted" style="text-align:center; margin-top:50px;">Sepetiniz ≈üuan bo≈ü.</p>`;
        return;
      }

      cart.forEach((c, idx)=>{
        const p = products.find(pp=>pp.id===c.id);
        if(!p) return;
        const it = document.createElement("div");
        it.className = "item";
        it.innerHTML = `
          <div style="font-size:24px;">${p.icon}</div>
          <div style="flex:1">
            <div style="font-weight:700; font-size:13px;">${p.name}</div>
            <div style="font-size:10px; color:#666;">Ekleyen: <b>${c.by}</b> ‚Ä¢ ${fmtTR(c.ts)}</div>
          </div>
          <button class="xbtn" data-idx="${idx}">√ó</button>
        `;
        drawerBody.appendChild(it);
      });

      drawerBody.querySelectorAll(".xbtn").forEach(b=>{
        b.addEventListener("click", ()=> removeFromCart(Number(b.dataset.idx)));
      });
    }

    // ----- √úr√ºnleri Ekrana Bas -----
    function renderProducts(){
      grid.innerHTML = "";
      products.forEach(p=>{
        const el = document.createElement("div");
        el.className = "pCard";
        el.innerHTML = `
          <div class="tag">${p.tag}</div>
          <div class="thumb">${p.icon}</div>
          <div style="flex:1; width:100%;">
            <p class="name">${p.name}</p>
            <p class="desc">${p.desc}</p>
          </div>
          <button class="btn addBtn" data-id="${p.id}" style="width:100%; border-color:#333; font-size:10px;">EKLE</button>
        `;
        grid.appendChild(el);
      });

      grid.querySelectorAll(".addBtn").forEach(btn=>{
        btn.addEventListener("click", ()=> addToCart(btn.dataset.id));
      });
    }

    // ----- Saya√ß -----
    let modeChangedAt = 0;
    let timerHandle = null;
    function startTimer(){
      if(timerHandle) clearInterval(timerHandle);
      timerHandle = setInterval(()=> {
        timerText.textContent = modeChangedAt ? formatDuration(Date.now() - modeChangedAt) : "0 sn";
      }, 1000);
    }

    // ----- Olay Dinleyiciler -----
    cartOpenBtn.addEventListener("click", openDrawer);
    cartCloseBtn.addEventListener("click", closeDrawer);

    clearCartBtn.addEventListener("click", ()=>{
      cart = [];
      updateCartUI();
      popToast("Sepet Temizlendi");
      writeCart().catch(()=>{});
    });

    btnPeace.addEventListener("click", async ()=>{
      renderMode(true);
      popToast("BARI≈û ƒ∞LAN EDƒ∞LDƒ∞ üïäÔ∏è");
      await updateDoc(stateRef, { peaceMode:true, modeChangedAt: nowTs() });
    });

    btnKus.addEventListener("click", async ()=>{
      renderMode(false);
      popToast("K√úSL√úK BA≈ûLADI ‚õàÔ∏è");
      await updateDoc(stateRef, { peaceMode:false, modeChangedAt: nowTs() });
    });

    sendHeart.addEventListener("click", async ()=>{
      burstHearts(14);
      popToast("Kalp G√∂nderildi ‚ù§Ô∏è");
      await updateDoc(stateRef, { hearts: increment(1) });
    });

    changeRole.addEventListener("click", openOverlay);
    
    // Pick eventleri artƒ±k direkt a√ßmƒ±yor, ≈üifreye y√∂nlendiriyor (HTML kƒ±smƒ±nda)

    document.addEventListener("visibilitychange", ()=>{ if(document.visibilityState === "visible") markRead().catch(()=>{}); });
    window.addEventListener("focus", ()=> markRead().catch(()=>{}));

    // ----- Ba≈ülatma -----
    renderProducts();
    updateCartUI();

    if(!viewer()) overlay.classList.add("open");
    else whoText.textContent = viewer();
    enforcePermissions();

    await ensureDefaults();

    onSnapshot(stateRef, (s)=>{
      if(!s.exists()) return;
      const d = s.data();

      // Durum ve Saya√ß
      renderMode(!!d.peaceMode);
      modeChangedAt = Number(d.modeChangedAt || 0);
      startTimer();

      // Kalp Sayƒ±sƒ±
      heartsPill.textContent = `${d.hearts ?? 0}`;

      // G√∂r√ºlme Bilgileri
      if(d.lastSeen?.name && d.lastSeen?.ts){
        lastSeenPill.textContent = `Son: ${d.lastSeen.name} (${fmtTR(d.lastSeen.ts)})`;
      }
      readPill.textContent = `Emir: ${fmtTR(d.reads?.Emir)} | Elif: ${fmtTR(d.reads?.Elif)}`;

      // Emir Notu
      const remoteEmir = String(d.emirNote || "");
      if(!emirTyping && emirNoteEl.value !== remoteEmir) emirNoteEl.value = remoteEmir;
      
      // Elif Notu
      const remoteElif = String(d.elifNote || "");
      if(!elifTyping && elifNoteEl.value !== remoteElif) elifNoteEl.value = remoteElif;

      // Sepet Senkronizasyonu
      const remoteCart = normalizeCart(d.cart);
      if(JSON.stringify(cart) !== JSON.stringify(remoteCart) && !suppressCartWrite){
        cart = remoteCart;
        updateCartUI();
      }

      enforcePermissions();
    });

    await markRead().catch(()=>{});
  </script>
</body>
</html>
