<!doctype html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ELIF BEAUTY ‚Ä¢ Bizim Sayfa</title>
  <style>
    :root{
      --bg:#0b0b0c; --card: rgba(255,255,255,.05); --line: rgba(255,255,255,.12);
      --text:#f4f4f6; --muted:#a0a0ab; --good:#55d6a7; --bad:#ff5c7a;
      --shadow: 0 18px 46px rgba(0,0,0,.48); --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(900px 700px at 15% -10%, rgba(255,255,255,.08), transparent 55%),
        radial-gradient(900px 700px at 90% 10%, rgba(255,255,255,.06), transparent 55%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    .top{position:sticky; top:0; z-index:20; backdrop-filter: blur(10px); background: rgba(10,10,11,.75); border-bottom:1px solid var(--line);}
    .topin{max-width:980px; margin:0 auto; padding:14px 16px; display:flex; align-items:center; gap:12px;}
    .brand{display:flex; align-items:center; gap:10px; font-weight:900; letter-spacing:.12em; text-transform:uppercase; user-select:none;}
    .badge{width:34px; height:34px; border-radius:12px; border:1px solid rgba(255,255,255,.22); display:grid; place-items:center; box-shadow: 0 10px 22px rgba(0,0,0,.35);}
    .right{margin-left:auto; display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;}
    .chip{padding:8px 12px; border-radius:999px; border:1px solid var(--line); background: rgba(255,255,255,.05); font-size:12px; color:rgba(255,255,255,.9); display:flex; align-items:center; gap:8px; user-select:none; white-space:nowrap;}
    .dot{width:7px; height:7px; border-radius:50%; background:var(--bad)} .dot.ok{background:var(--good)}
    .link{font-size:12px; color:rgba(255,255,255,.85); border-bottom:1px dashed rgba(255,255,255,.25); cursor:pointer; user-select:none;}
    .count{min-width:22px; height:22px; border-radius:999px; display:grid; place-items:center; background: rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.18); font-size:12px; padding:0 7px;}

    .wrap{max-width:980px; margin:0 auto; padding:16px;}
    .card{background: var(--card); border:1px solid var(--line); border-radius: var(--r); box-shadow: var(--shadow); padding:16px; margin-top:14px;}
    .title{margin:0 0 6px; font-size:18px}
    .muted{color:var(--muted); font-size:12px; line-height:1.5; margin:0}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .divider{height:1px; background:rgba(255,255,255,.10); margin:14px 0}

    .btn{border:1px solid rgba(255,255,255,.18); background: rgba(255,255,255,.06); color:var(--text); padding:10px 12px; border-radius:999px; cursor:pointer; font-weight:800; font-size:13px; user-select:none; transition:.18s ease; white-space:nowrap;}
    .btn:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.30)}
    .btn.primary{background:#fff; color:#0b0b0c; border-color: rgba(255,255,255,.6)}
    .btn.danger{border-color: rgba(255,92,122,.35); background: rgba(255,92,122,.10)}
    .btn[disabled]{opacity:.45; cursor:not-allowed; transform:none !important;}

    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px;}
    textarea{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:12px 12px;
      outline:none;
      font-size:14px;
      min-height:120px;
      resize:vertical;
    }

    .grid{display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; margin-top:12px;}
    @media(max-width:900px){ .grid{grid-template-columns: repeat(2,1fr)} }
    @media(max-width:620px){ .grid{grid-template-columns: 1fr} }

    .pCard{border:1px solid rgba(255,255,255,.12); background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)); border-radius:18px; padding:14px; display:flex; gap:12px; align-items:flex-start; box-shadow: 0 10px 26px rgba(0,0,0,.35);}
    .thumb{width:54px; height:54px; border-radius:16px; border:1px solid rgba(255,255,255,.16); background: rgba(255,255,255,.08); display:grid; place-items:center; user-select:none; flex:0 0 auto;}
    .meta{flex:1}
    .name{font-weight:900; margin:0; font-size:14px;}
    .desc{margin:6px 0 10px; color:var(--muted); font-size:13px; line-height:1.45;}
    .tag{font-size:12px; color: rgba(255,255,255,.88); border:1px solid rgba(255,255,255,.18); background: rgba(255,255,255,.06); padding:6px 10px; border-radius:999px; white-space:nowrap; user-select:none;}

    .drawer{position:fixed; top:0; right:0; width:min(440px, 92vw); height:100%; background: rgba(12,12,13,.92); border-left:1px solid rgba(255,255,255,.14); backdrop-filter: blur(10px); transform: translateX(110%); transition:.25s ease; z-index:100; display:flex; flex-direction:column; box-shadow: -20px 0 50px rgba(0,0,0,.5);}
    .drawer.open{transform: translateX(0)}
    .drawer-header{padding:16px; border-bottom:1px solid rgba(255,255,255,.10); display:flex; justify-content:space-between; gap:10px; align-items:center;}
    .drawer-header h3{margin:0; letter-spacing:.12em; text-transform:uppercase; font-size:14px;}
    .drawer-body{padding:14px 16px; overflow:auto; flex:1}
    .item{display:flex; align-items:flex-start; gap:10px; padding:12px; border-radius:16px; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.04); margin-bottom:10px;}
    .item .thumb{width:44px;height:44px;border-radius:14px}
    .mini{font-size:12px; color:var(--muted); line-height:1.35;}
    .xbtn{margin-left:auto; border:1px solid rgba(255,255,255,.18); background: transparent; color:rgba(255,255,255,.9); border-radius:999px; cursor:pointer; padding:6px 10px; font-size:12px; user-select:none;}
    .drawer-footer{border-top:1px solid rgba(255,255,255,.10); padding:14px 16px; display:grid; gap:10px;}

    .pill{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.06); font-size:12px; user-select:none; white-space:nowrap;}
    .pill.ok{border-color: rgba(85,214,167,.35); background: rgba(85,214,167,.10);}
    .pill.bad{border-color: rgba(255,92,122,.35); background: rgba(255,92,122,.10);}

    .overlay{position:fixed; inset:0; background: rgba(0,0,0,.72); backdrop-filter: blur(6px); display:none; align-items:center; justify-content:center; padding:18px; z-index:500;}
    .overlay.open{display:flex}
    .modal{width:min(520px, 96vw); background: rgba(12,12,13,.94); border:1px solid rgba(255,255,255,.14); border-radius:22px; box-shadow: var(--shadow); padding:16px;}
    .modal h3{margin:0 0 8px; font-size:14px; letter-spacing:.10em; text-transform:uppercase;}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;}
    @media(max-width:520px){.grid2{grid-template-columns:1fr}}
    .roleBtn{border-radius:18px; padding:14px 12px; border:1px solid rgba(255,255,255,.16); background: rgba(255,255,255,.06); color:var(--text); cursor:pointer; text-align:left; transition:.18s ease;}
    .roleBtn:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.32)}
    .roleBtn b{display:block; font-size:15px; margin-bottom:6px;}
    .roleBtn span{color:var(--muted); font-size:12px; line-height:1.4;}

    .toast{position:fixed; left:50%; bottom:16px; transform:translateX(-50%); background: rgba(255,255,255,.92); color:#0b0b0c; padding:10px 12px; border-radius:999px; font-weight:900; font-size:13px; box-shadow: var(--shadow); display:none; z-index:200;}
    .toast.show{display:block}

    .heart{position:fixed; font-size:18px; pointer-events:none; animation: floatUp 1.2s ease forwards; z-index:999; filter: drop-shadow(0 10px 16px rgba(0,0,0,.35));}
    @keyframes floatUp{from{ transform: translateY(0) scale(1); opacity:1 }to{ transform: translateY(-120px) scale(1.35); opacity:0 }}
  </style>
</head>

<body>
  <div class="top">
    <div class="topin">
      <div class="brand"><div class="badge">‚ú¶</div>ELIF BEAUTY</div>

      <div class="right">
        <div class="chip"><span class="dot" id="modeDot"></span><span id="modeText">K√ºs</span></div>
        <div class="chip">‚è± <span id="timerText">0 sn</span></div>
        <button class="btn" id="cartOpenBtn">Sepet <span class="count" id="cartCount">0</span></button>
        <div class="chip"><span id="whoText">Sen: -</span> ‚Ä¢ <span class="link" id="changeRole">Deƒüi≈ütir</span></div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <h2 class="title">Durum</h2>
      <p class="muted">Mod deƒüi≈üince saya√ß sƒ±fƒ±rlanƒ±r ve tekrar sayar.</p>
      <div class="divider"></div>
      <div class="row">
        <button class="btn primary" id="btnPeace">Barƒ±≈ü</button>
        <button class="btn danger" id="btnKus">K√ºs</button>
        <button class="btn" id="sendHeart">Kalp G√∂nder</button>
        <span class="pill" id="heartsPill">Kalp: 0</span>
        <span class="pill" id="lastSeenPill">Son bakan: -</span>
        <span class="pill" id="readPill">Okundu: -</span>
      </div>
    </div>

    <div class="card">
      <h2 class="title">Notlar</h2>
      <p class="muted">Emir‚Äôin notu ayrƒ±, Elif‚Äôin notu ayrƒ±. Herkes sadece kendi notunu yazar.</p>

      <div class="divider"></div>

      <label>Emir‚Äôin notu (sadece Emir yazabilir)</label>
      <textarea id="emirNote" placeholder="Emir buraya yazacak‚Ä¶"></textarea>
      <div class="row" style="justify-content:space-between; margin-top:10px;">
        <button class="btn" id="copyEmir">Emir Notunu Kopyala</button>
        <span class="pill" id="emirSavedPill">Senkron: -</span>
      </div>

      <div class="divider"></div>

      <label>Elif‚Äôin notu (sadece Elif yazabilir)</label>
      <textarea id="elifNote" placeholder="Elif buraya yazacak‚Ä¶"></textarea>
      <div class="row" style="justify-content:flex-end; margin-top:10px;">
        <span class="pill" id="elifSavedPill">Senkron: -</span>
      </div>
    </div>

    <div class="card">
      <h2 class="title">Koleksiyon</h2>
      <p class="muted">Sephora hissi: √ºr√ºn kartlarƒ± + sepete ekleme. Sepette kim ekledi g√∂r√ºn√ºr.</p>
      <div class="grid" id="grid"></div>
    </div>
  </div>

  <aside class="drawer" id="drawer" aria-hidden="true">
    <div class="drawer-header">
      <h3>SEPET</h3>
      <button class="btn" id="cartCloseBtn">Kapat</button>
    </div>
    <div class="drawer-body" id="drawerBody"></div>
    <div class="drawer-footer">
      <div class="row" style="justify-content:space-between;">
        <span class="mini" id="cartSummary">0 √ºr√ºn</span>
        <button class="btn danger" id="clearCartBtn">Bo≈üalt</button>
      </div>
    </div>
  </aside>

  <div class="toast" id="toast">‚úÖ</div>

  <div class="overlay" id="overlay">
    <div class="modal">
      <h3>Sen kimsin?</h3>
      <p class="muted" style="margin:0;">Bu se√ßim sadece bu cihazda hatƒ±rlanƒ±r.</p>
      <div class="grid2">
        <button class="roleBtn" id="pickEmir"><b>Ben Emir‚Äôim</b><span>Emir notunu yazarsƒ±n.</span></button>
        <button class="roleBtn" id="pickElif"><b>Ben Elif‚Äôim</b><span>Elif notunu yazarsƒ±n.</span></button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, increment } from
      "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // ‚úÖ BURAYI KENDƒ∞ CONFIG'ƒ∞NLE DOLDUR
    const firebaseConfig = {
     apiKey: "AIzaSyAYOjXNc0vfzNL68z4pmbX8kFoQSC11LZ8",
  authDomain: "elif-site.firebaseapp.com",
  projectId: "elif-site",
  storageBucket: "elif-site.firebasestorage.app",
  messagingSenderId: "740065601752",
  appId: "1:740065601752:web:38898a11ab28cba588cfad",
  measurementId: "G-53C6DN719D"
    };

    // ----- UI -----
    const overlay = document.getElementById("overlay");
    const pickEmir = document.getElementById("pickEmir");
    const pickElif = document.getElementById("pickElif");
    const whoText = document.getElementById("whoText");
    const changeRole = document.getElementById("changeRole");

    const modeDot = document.getElementById("modeDot");
    const modeText = document.getElementById("modeText");
    const timerText = document.getElementById("timerText");
    const btnPeace = document.getElementById("btnPeace");
    const btnKus = document.getElementById("btnKus");

    const sendHeart = document.getElementById("sendHeart");
    const heartsPill = document.getElementById("heartsPill");
    const lastSeenPill = document.getElementById("lastSeenPill");
    const readPill = document.getElementById("readPill");

    const emirNoteEl = document.getElementById("emirNote");
    const elifNoteEl = document.getElementById("elifNote");
    const emirSavedPill = document.getElementById("emirSavedPill");
    const elifSavedPill = document.getElementById("elifSavedPill");
    const copyEmir = document.getElementById("copyEmir");

    const grid = document.getElementById("grid");

    const drawer = document.getElementById("drawer");
    const cartOpenBtn = document.getElementById("cartOpenBtn");
    const cartCloseBtn = document.getElementById("cartCloseBtn");
    const drawerBody = document.getElementById("drawerBody");
    const cartCount = document.getElementById("cartCount");
    const cartSummary = document.getElementById("cartSummary");
    const clearCartBtn = document.getElementById("clearCartBtn");

    const toast = document.getElementById("toast");

    // ----- Products -----
    const products = [
      { id:"p1", icon:"ü§ç", name:"Net √ñz√ºr Serum", tag:"Best Seller", desc:"Kƒ±sa, net, savunmasƒ±z bir √∂z√ºr." },
      { id:"p2", icon:"üß†", name:"Anlayƒ±≈ü Tonik", tag:"Gentle", desc:"‚ÄòSeni anlƒ±yorum‚Äô c√ºmlesini doƒüru kurar." },
      { id:"p3", icon:"üéß", name:"Dinleme Maskesi", tag:"Deep Care", desc:"S√∂z√ºn√º kesmeden dinleme modu." },
      { id:"p4", icon:"‚òï", name:"Kahve + Y√ºr√ºy√º≈ü", tag:"Classic", desc:"Somut telafi: sakin bir konu≈üma." },
      { id:"p5", icon:"üìµ", name:"Baskƒ±sƒ±z Alan SPF", tag:"Respect", desc:"√úst √ºste yazmama, alan tanƒ±ma." },
      { id:"p6", icon:"üéÅ", name:"K√º√ß√ºk Jest Mini", tag:"Cute", desc:"D√º≈ü√ºnceli k√º√ß√ºk s√ºrpriz." },
    ];

    // ----- Helpers -----
    const nowTs = () => Date.now();
    const fmtTR = (ts) => ts ? new Date(ts).toLocaleString("tr-TR") : "-";

    function popToast(text="‚úÖ"){
      toast.textContent = text;
      toast.classList.add("show");
      setTimeout(()=>toast.classList.remove("show"), 1100);
    }
    function copyText(str){
      navigator.clipboard.writeText(str)
        .then(()=>popToast("Kopyalandƒ± ‚úÖ"))
        .catch(()=>popToast("Kopyalanamadƒ± ‚ùå"));
    }
    function heart(x,y,emoji="‚ù§Ô∏è"){
      const h = document.createElement("div");
      h.className="heart";
      h.textContent = emoji;
      h.style.left = x + "px";
      h.style.top = y + "px";
      document.body.appendChild(h);
      setTimeout(()=>h.remove(), 1200);
    }
    function burstHearts(n=12){
      const cx = window.innerWidth - 80;
      const cy = 90;
      for(let i=0;i<n;i++){
        const x = cx + (Math.random()*40 - 20);
        const y = cy + (Math.random()*30 - 15);
        setTimeout(()=>heart(x,y, Math.random()>.25?"‚ù§Ô∏è":"ü§ç"), i*35);
      }
    }
    function openDrawer(){ drawer.classList.add("open"); drawer.setAttribute("aria-hidden","false"); }
    function closeDrawer(){ drawer.classList.remove("open"); drawer.setAttribute("aria-hidden","true"); }

    function formatDuration(ms){
      if(ms < 0) ms = 0;
      const s = Math.floor(ms/1000);
      const days = Math.floor(s/86400);
      const hrs  = Math.floor((s%86400)/3600);
      const mins = Math.floor((s%3600)/60);
      const secs = s%60;
      const parts = [];
      if(days) parts.push(`${days} g√ºn`);
      if(hrs || days) parts.push(`${hrs} saat`);
      if(mins || hrs || days) parts.push(`${mins} dk`);
      parts.push(`${secs} sn`);
      return parts.join(" ");
    }
    function renderMode(isPeace){
      if(isPeace){ modeText.textContent = "Barƒ±≈ü"; modeDot.classList.add("ok"); }
      else { modeText.textContent = "K√ºs"; modeDot.classList.remove("ok"); }
    }
    function setPill(el, text, ok=false){
      el.textContent = text;
      el.classList.toggle("ok", ok);
    }

    // ----- Role -----
    function viewer(){ return localStorage.getItem("viewerName") || ""; }
    function isEmir(){ return viewer() === "Emir"; }
    function isElif(){ return viewer() === "Elif"; }

    function setViewer(name){
      localStorage.setItem("viewerName", name);
      whoText.textContent = `Sen: ${name}`;
      overlay.classList.remove("open");
      enforcePermissions();
    }
    function openOverlay(){ overlay.classList.add("open"); }

    function enforcePermissions(){
      // Emir alanƒ± sadece Emir, Elif alanƒ± sadece Elif
      emirNoteEl.readOnly = !isEmir();
      elifNoteEl.readOnly = !isElif();
      copyEmir.disabled = !isEmir(); // Emir kopyalasƒ±n (istersen bunu a√ßarƒ±z)
    }

    // ----- Firestore -----
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const stateRef = doc(db, "shared", "relationshipState");

    async function ensureDefaults(){
      const snap = await getDoc(stateRef);
      const base = {
        peaceMode: false,
        modeChangedAt: nowTs(),
        emirNote: "",
        elifNote: "",
        emirNoteUpdatedAt: 0,
        elifNoteUpdatedAt: 0,
        cart: [],              // [{id, by, ts}]
        hearts: 0,
        reads: {},
        lastSeen: {}
      };
      if(!snap.exists()){
        await setDoc(stateRef, base);
      } else {
        // mevcut dok√ºmana eksik alanlarƒ± ekle
        await setDoc(stateRef, base, { merge: true });
      }
    }

    let lastPingAt = 0;
    async function pingSeenDebounced(name){
      const now = nowTs();
      if(now - lastPingAt < 4000) return;
      lastPingAt = now;
      await updateDoc(stateRef, { lastSeen: { name, ts: now } });
    }

    async function markRead(){
      const v = viewer();
      if(!v) return;
      await updateDoc(stateRef, { [`reads.${v}`]: nowTs() });
      await pingSeenDebounced(v);
    }

    // ----- Notes autosave (separate) -----
    let emirTimer = null;
    let elifTimer = null;

    async function saveEmirNote(val){
      setPill(emirSavedPill, "Senkron: yazƒ±lƒ±yor‚Ä¶", false);
      await updateDoc(stateRef, { emirNote: String(val||""), emirNoteUpdatedAt: nowTs() });
      setPill(emirSavedPill, "Senkron: kaydedildi ‚úÖ", true);
      const v = viewer(); if(v) await pingSeenDebounced(v);
    }

    async function saveElifNote(val){
      setPill(elifSavedPill, "Senkron: yazƒ±lƒ±yor‚Ä¶", false);
      await updateDoc(stateRef, { elifNote: String(val||""), elifNoteUpdatedAt: nowTs() });
      setPill(elifSavedPill, "Senkron: kaydedildi ‚úÖ", true);
      const v = viewer(); if(v) await pingSeenDebounced(v);
    }

    emirNoteEl.addEventListener("input", ()=>{
      if(!isEmir()) return;
      clearTimeout(emirTimer);
      emirTimer = setTimeout(()=> saveEmirNote(emirNoteEl.value).catch(()=>{}), 300);
    });

    elifNoteEl.addEventListener("input", ()=>{
      if(!isElif()) return;
      clearTimeout(elifTimer);
      elifTimer = setTimeout(()=> saveElifNote(elifNoteEl.value).catch(()=>{}), 300);
    });

    copyEmir.addEventListener("click", ()=>{
      if(!isEmir()) return;
      copyText(emirNoteEl.value || "");
    });

    // ----- Cart state -----
    let cart = [];                 // [{id, by, ts}]
    let suppressCartWrite = false;

    function normalizeCart(remoteCart){
      if(!Array.isArray(remoteCart)) return [];
      if(remoteCart.length === 0) return [];
      if(typeof remoteCart[0] === "string"){
        return remoteCart.map(id => ({ id, by:"?", ts:0 }));
      }
      return remoteCart
        .filter(x => x && typeof x.id === "string")
        .map(x => ({ id:x.id, by: String(x.by||"?"), ts: Number(x.ts||0) }));
    }
    function cartKey(list){
      return JSON.stringify(list.map(x=>x.id+"|"+x.by+"|"+x.ts));
    }
    async function writeCart(){
      if(suppressCartWrite) return;
      await updateDoc(stateRef, { cart });
      const v = viewer(); if(v) await pingSeenDebounced(v);
    }

    function addToCart(id){
      const v = viewer() || "?";
      cart.push({ id, by: v, ts: nowTs() });
      updateCartUI();
      burstHearts(8);
      popToast("Sepete eklendi");
      writeCart().catch(()=>{});
    }
    function removeFromCart(idx){
      cart.splice(idx,1);
      updateCartUI();
      writeCart().catch(()=>{});
    }

    function updateCartUI(){
      cartCount.textContent = String(cart.length);
      cartSummary.textContent = `${cart.length} √ºr√ºn`;
      drawerBody.innerHTML = "";

      if(cart.length === 0){
        drawerBody.innerHTML = `<p class="mini">Sepet bo≈ü.</p>`;
        return;
      }

      cart.forEach((c, idx)=>{
        const p = products.find(pp=>pp.id===c.id);
        if(!p) return;
        const it = document.createElement("div");
        it.className = "item";
        it.innerHTML = `
          <div class="thumb"><span style="font-size:18px">${p.icon}</span></div>
          <div style="flex:1">
            <div style="font-weight:900">${p.name}</div>
            <div class="mini">${p.desc}</div>
            <div class="mini"><b>${c.by}</b> ekledi ‚Ä¢ ${c.ts ? fmtTR(c.ts) : "-"}</div>
          </div>
          <button class="xbtn" data-idx="${idx}">Sil</button>
        `;
        drawerBody.appendChild(it);
      });

      drawerBody.querySelectorAll(".xbtn").forEach(b=>{
        b.addEventListener("click", ()=> removeFromCart(Number(b.dataset.idx)));
      });
    }

    // ----- Products UI -----
    function renderProducts(){
      grid.innerHTML = "";
      products.forEach(p=>{
        const el = document.createElement("div");
        el.className = "pCard";
        el.innerHTML = `
          <div class="thumb"><span style="font-size:22px">${p.icon}</span></div>
          <div class="meta">
            <div class="row" style="justify-content:space-between; gap:10px;">
              <p class="name">${p.name}</p>
              <span class="tag">${p.tag}</span>
            </div>
            <p class="desc">${p.desc}</p>
            <div class="row" style="justify-content:flex-end;">
              <button class="btn primary addBtn" data-id="${p.id}">Sepete Ekle</button>
            </div>
          </div>
        `;
        grid.appendChild(el);
      });

      grid.querySelectorAll(".addBtn").forEach(btn=>{
        btn.addEventListener("click", ()=> addToCart(btn.dataset.id));
      });
    }

    // ----- Timer -----
    let modeChangedAt = 0;
    let timerHandle = null;
    function startTimer(){
      if(timerHandle) clearInterval(timerHandle);
      timerHandle = setInterval(()=> {
        timerText.textContent = modeChangedAt ? formatDuration(Date.now() - modeChangedAt) : "0 sn";
      }, 1000);
    }

    // ----- Events -----
    cartOpenBtn.addEventListener("click", openDrawer);
    cartCloseBtn.addEventListener("click", closeDrawer);

    clearCartBtn.addEventListener("click", ()=>{
      cart = [];
      updateCartUI();
      popToast("Sepet bo≈üaltƒ±ldƒ±");
      writeCart().catch(()=>{});
    });

    btnPeace.addEventListener("click", async ()=>{
      renderMode(true);
      popToast("Barƒ±≈ü ‚úÖ");
      await updateDoc(stateRef, { peaceMode:true, modeChangedAt: nowTs() });
      const v = viewer(); if(v) await pingSeenDebounced(v);
    });

    btnKus.addEventListener("click", async ()=>{
      renderMode(false);
      popToast("K√ºs ‚úÖ");
      await updateDoc(stateRef, { peaceMode:false, modeChangedAt: nowTs() });
      const v = viewer(); if(v) await pingSeenDebounced(v);
    });

    sendHeart.addEventListener("click", async ()=>{
      burstHearts(14);
      popToast("Kalp üíå");
      await updateDoc(stateRef, { hearts: increment(1) });
      const v = viewer(); if(v) await pingSeenDebounced(v);
    });

    changeRole.addEventListener("click", openOverlay);
    pickEmir.addEventListener("click", async ()=>{ setViewer("Emir"); await markRead().catch(()=>{}); });
    pickElif.addEventListener("click", async ()=>{ setViewer("Elif"); await markRead().catch(()=>{}); });

    document.addEventListener("visibilitychange", ()=>{ if(document.visibilityState === "visible") markRead().catch(()=>{}); });
    window.addEventListener("focus", ()=> markRead().catch(()=>{}));

    // ----- Boot -----
    renderProducts();
    updateCartUI();

    if(!viewer()) overlay.classList.add("open");
    else whoText.textContent = `Sen: ${viewer()}`;
    enforcePermissions();

    await ensureDefaults();

    onSnapshot(stateRef, (s)=>{
      if(!s.exists()) return;
      const d = s.data();

      // mode + timer
      renderMode(!!d.peaceMode);
      modeChangedAt = Number(d.modeChangedAt || 0);
      startTimer();

      // hearts
      heartsPill.textContent = `Kalp: ${d.hearts ?? 0}`;

      // seen / read
      if(d.lastSeen?.name && d.lastSeen?.ts){
        lastSeenPill.textContent = `Son bakan: ${d.lastSeen.name} ‚Ä¢ ${fmtTR(d.lastSeen.ts)}`;
      } else {
        lastSeenPill.textContent = "Son bakan: -";
      }
      readPill.textContent = `Okundu ‚Ä¢ Emir: ${fmtTR(d.reads?.Emir)} ‚Ä¢ Elif: ${fmtTR(d.reads?.Elif)}`;

      // emir note
      const remoteEmir = String(d.emirNote || "");
      if(!isEmir()){ // Emir deƒüilken remote her zaman yansƒ±sƒ±n
        if(emirNoteEl.value !== remoteEmir) emirNoteEl.value = remoteEmir;
      } else {
        // Emir yazƒ±yorken: remote farklƒ±ysa yine de e≈üitle (tek kullanƒ±cƒ± yazƒ±yor varsayƒ±mƒ±)
        if(emirNoteEl.value !== remoteEmir) emirNoteEl.value = remoteEmir;
      }
      const emirAt = Number(d.emirNoteUpdatedAt || 0);
      if(remoteEmir.trim()){
        setPill(emirSavedPill, `Senkron ‚úÖ ‚Ä¢ ${fmtTR(emirAt)}`, true);
      } else {
        emirSavedPill.textContent = "Senkron: -"; emirSavedPill.classList.remove("ok");
      }

      // elif note
      const remoteElif = String(d.elifNote || "");
      if(!isElif()){
        if(elifNoteEl.value !== remoteElif) elifNoteEl.value = remoteElif;
      } else {
        if(elifNoteEl.value !== remoteElif) elifNoteEl.value = remoteElif;
      }
      const elifAt = Number(d.elifNoteUpdatedAt || 0);
      if(remoteElif.trim()){
        setPill(elifSavedPill, `Senkron ‚úÖ ‚Ä¢ ${fmtTR(elifAt)}`, true);
      } else {
        elifSavedPill.textContent = "Senkron: -"; elifSavedPill.classList.remove("ok");
      }

      // cart
      const remoteCart = normalizeCart(d.cart);
      const same = cartKey(cart) === cartKey(remoteCart);
      if(!same){
        suppressCartWrite = true;
        cart = remoteCart;
        updateCartUI();
        suppressCartWrite = false;
      }

      enforcePermissions();
    });

    await markRead().catch(()=>{});
    const v = viewer(); if(v) await pingSeenDebounced(v).catch(()=>{});
  </script>
</body>
</html>
