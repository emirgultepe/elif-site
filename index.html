<!doctype html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ELIF BEAUTY ‚Ä¢ G√∂n√ºl Onarƒ±m Maƒüazasƒ±</title>
  <style>
    :root{
      --bg:#0b0b0c;
      --muted:#9b9ba3;
      --text:#f3f3f5;
      --line:#232327;
      --accent:#ffffff;
      --good:#55d6a7;
      --bad:#ff5c7a;
      --shadow: 0 16px 40px rgba(0,0,0,.45);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 20% -10%, rgba(255,255,255,.08), transparent 55%),
                  radial-gradient(900px 700px at 90% 10%, rgba(255,255,255,.06), transparent 55%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
      overflow-x:hidden;
    }

    .topbar{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(10px);
      background: rgba(10,10,11,.7);
      border-bottom:1px solid var(--line);
    }
    .topbar-inner{
      max-width:1100px;
      margin:0 auto;
      padding:14px 18px;
      display:flex;
      align-items:center;
      gap:14px;
    }
    .logo{
      display:flex; align-items:center; gap:10px;
      font-weight:800;
      letter-spacing:.12em;
      text-transform:uppercase;
      user-select:none;
      white-space:nowrap;
    }
    .logo-badge{
      width:34px; height:34px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.25);
      display:grid; place-items:center;
      box-shadow: 0 10px 22px rgba(0,0,0,.35);
    }
    .logo-badge span{font-size:16px}
    .search{
      flex:1;
      display:flex;
      align-items:center;
      gap:10px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius:999px;
      padding:10px 14px;
      min-width:140px;
    }
    .search input{
      flex:1;
      background:transparent;
      border:0;
      outline:none;
      color:var(--text);
      font-size:14px;
    }
    .search .hint{color:var(--muted); font-size:12px}
    .actions{display:flex; gap:10px; align-items:center}
    .btn{
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      transition:.18s ease;
      font-weight:600;
      font-size:13px;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.32)}
    .btn.primary{
      background: var(--accent);
      color:#0b0b0c;
      border-color: rgba(255,255,255,.6);
    }
    .btn.danger{
      border-color: rgba(255,92,122,.35);
      background: rgba(255,92,122,.10);
    }
    .btn[disabled]{opacity:.45; cursor:not-allowed; transform:none !important;}
    .pill{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      color:var(--muted);
      font-size:12px;
      display:flex; align-items:center; gap:8px;
      user-select:none;
    }
    .dot{width:7px; height:7px; border-radius:50%; background:var(--bad)}
    .dot.ok{background:var(--good)}
    .count{
      min-width:22px;
      height:22px;
      border-radius:999px;
      display:grid; place-items:center;
      background: rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.18);
      font-size:12px;
      padding:0 7px;
    }

    .wrap{max-width:1100px; margin:0 auto; padding:18px;}
    .hero{display:grid; grid-template-columns: 1.2fr .8fr; gap:18px; margin-top:16px;}
    @media (max-width:900px){ .hero{grid-template-columns:1fr} }

    .panel{
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.12);
      border-radius: var(--radius);
      padding:18px;
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .panel:before{
      content:"";
      position:absolute;
      inset:-2px;
      background: radial-gradient(600px 280px at 15% 10%, rgba(255,255,255,.10), transparent 60%);
      pointer-events:none;
    }
    .hero h1{margin:0 0 10px; font-size:34px; letter-spacing:.01em;}
    .sub{color:var(--muted); line-height:1.6; margin:0 0 14px; max-width:60ch;}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .tiny{color:var(--muted); font-size:12px; line-height:1.5;}
    .divider{height:1px; background: var(--line); margin:14px 0}

    .section-title{
      margin:26px 0 10px;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
    }
    .section-title h2{
      margin:0;
      font-size:16px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color: rgba(255,255,255,.9);
    }
    .grid{display:grid; grid-template-columns: repeat(3, 1fr); gap:14px;}
    @media (max-width:980px){ .grid{grid-template-columns: repeat(2,1fr)} }
    @media (max-width:640px){ .grid{grid-template-columns: 1fr} }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.12);
      border-radius: var(--radius);
      padding:14px;
      box-shadow: 0 10px 26px rgba(0,0,0,.35);
      display:flex;
      gap:12px;
      position:relative;
      overflow:hidden;
    }
    .thumb{
      width:54px; height:54px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      display:grid; place-items:center;
      flex:0 0 auto;
    }
    .thumb span{font-size:22px}
    .meta{flex:1}
    .name{font-weight:800; margin:0; font-size:15px; letter-spacing:.01em;}
    .desc{margin:6px 0 10px; color:var(--muted); font-size:13px; line-height:1.5;}
    .price{display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .tag{
      font-size:12px;
      color: rgba(255,255,255,.88);
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      padding:6px 10px;
      border-radius:999px;
      white-space:nowrap;
    }
    .add{
      border:0;
      cursor:pointer;
      background: rgba(255,255,255,.92);
      color:#0b0b0c;
      padding:9px 12px;
      border-radius:999px;
      font-weight:800;
      font-size:13px;
      transition:.18s ease;
      white-space:nowrap;
    }
    .add:hover{transform: translateY(-1px)}
    .add[disabled]{opacity:.45; cursor:not-allowed; transform:none !important;}

    .drawer{
      position:fixed;
      top:0; right:0;
      width:min(420px, 92vw);
      height:100%;
      background: rgba(12,12,13,.92);
      border-left:1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(10px);
      transform: translateX(110%);
      transition:.25s ease;
      z-index:100;
      display:flex;
      flex-direction:column;
      box-shadow: -20px 0 50px rgba(0,0,0,.5);
    }
    .drawer.open{transform: translateX(0)}
    .drawer-header{
      padding:16px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .drawer-header h3{
      margin:0;
      letter-spacing:.12em;
      text-transform:uppercase;
      font-size:14px;
    }
    .drawer-body{padding:14px 16px; overflow:auto; flex:1}
    .item{
      display:flex;
      align-items:flex-start;
      gap:10px;
      padding:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      border-radius:16px;
      margin-bottom:10px;
    }
    .item .thumb{width:44px;height:44px;border-radius:14px}
    .item .name{font-size:14px}
    .item .desc{margin:4px 0 0; font-size:12px}
    .remove{
      margin-left:auto;
      border:1px solid rgba(255,255,255,.18);
      background: transparent;
      color:rgba(255,255,255,.9);
      border-radius:999px;
      cursor:pointer;
      padding:6px 10px;
      font-size:12px;
      user-select:none;
    }
    .remove[disabled]{opacity:.45; cursor:not-allowed;}

    .modal{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.6);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:200;
      padding:18px;
    }
    .modal.open{display:flex}
    .modal-card{
      width:min(760px, 96vw);
      background: rgba(12,12,13,.92);
      border:1px solid rgba(255,255,255,.14);
      border-radius: 22px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal-top{
      padding:16px 16px 12px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .modal-top h3{
      margin:0;
      font-size:14px;
      letter-spacing:.12em;
      text-transform:uppercase;
    }
    .modal-body{
      padding:16px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    @media (max-width:860px){ .modal-body{grid-template-columns:1fr} }
    .box{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      border-radius: 18px;
      padding:14px;
    }
    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:10px 0 6px;
    }
    input, textarea{
      width:100%;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:12px 12px;
      outline:none;
      font-size:14px;
    }
    textarea{min-height:120px; resize:vertical}
    .modal-actions{
      padding:14px 16px 16px;
      border-top:1px solid var(--line);
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform: translateX(-50%);
      background: rgba(255,255,255,.92);
      color:#0b0b0c;
      padding:10px 12px;
      border-radius:999px;
      font-weight:800;
      font-size:13px;
      box-shadow: var(--shadow);
      display:none;
      z-index:300;
    }
    .toast.show{display:block; animation: pop .18s ease}
    @keyframes pop{
      from{transform:translateX(-50%) scale(.95);opacity:.2}
      to{transform:translateX(-50%) scale(1);opacity:1}
    }

    .heart{
      position:fixed;
      font-size:18px;
      pointer-events:none;
      animation: floatUp 1.2s ease forwards;
      filter: drop-shadow(0 10px 16px rgba(0,0,0,.35));
      z-index:999;
    }
    @keyframes floatUp{
      from{ transform: translateY(0) scale(1); opacity:1 }
      to{ transform: translateY(-120px) scale(1.35); opacity:0 }
    }

    footer{
      max-width:1100px;
      margin:24px auto 40px;
      padding:0 18px;
      color:var(--muted);
      font-size:12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    /* Role overlay */
    .roleOverlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.72);
      backdrop-filter: blur(6px);
      display:none;
      z-index:500;
      padding:18px;
      align-items:center;
      justify-content:center;
    }
    .roleOverlay.open{display:flex}
    .roleCard{
      width:min(520px, 96vw);
      background: rgba(12,12,13,.94);
      border:1px solid rgba(255,255,255,.14);
      border-radius:22px;
      box-shadow: var(--shadow);
      padding:16px;
    }
    .roleCard h3{
      margin:0 0 8px;
      letter-spacing:.10em;
      text-transform:uppercase;
      font-size:14px;
    }
    .roleGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    @media (max-width:520px){ .roleGrid{grid-template-columns:1fr} }
    .roleBtn{
      border-radius:18px;
      padding:14px 12px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
      text-align:left;
      transition:.18s ease;
    }
    .roleBtn:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.32)}
    .roleBtn b{display:block; font-size:15px; margin-bottom:6px;}
    .roleBtn span{color:var(--muted); font-size:12px; line-height:1.4;}
    .miniLink{
      color:rgba(255,255,255,.85);
      font-size:12px;
      cursor:pointer;
      user-select:none;
      border-bottom:1px dashed rgba(255,255,255,.25);
    }

    .statusLine{
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      margin-top:8px;
    }
    .savedBadge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-size:12px;
      color: rgba(255,255,255,.9);
      user-select:none;
    }
    .savedBadge.ok{border-color: rgba(85,214,167,.35); background: rgba(85,214,167,.10);}
    .savedBadge.wait{border-color: rgba(255,255,255,.14); opacity:.85}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="logo">
        <div class="logo-badge"><span>‚ú¶</span></div>
        ELIF BEAUTY
      </div>

      <div class="search" title="Arama">
        <span style="opacity:.9">‚åï</span>
        <input id="q" placeholder="Bir ≈üey ara‚Ä¶ (√∂rn: √∂z√ºr, kahve, sarƒ±lma)" />
        <span class="hint">Enter</span>
      </div>

      <div class="actions">
        <div class="pill" id="statusPill">
          <span class="dot" id="dot"></span>
          <span id="statusText">K√ºs Modu</span>
        </div>

        <button class="btn" id="surpriseBtn">S√ºrpriz</button>
        <button class="btn primary" id="cartBtn">G√∂n√ºl Sepeti <span class="count" id="cartCount">0</span></button>
      </div>
    </div>
  </div>

  <main class="wrap">
    <section class="hero">
      <div class="panel">
        <h1>Elif‚Äôin g√∂nl√ºn√º almak i√ßin<br/>≈üƒ±k bir ‚Äútelafi koleksiyonu‚Äù.</h1>
        <p class="sub">
          Buradaki her ‚Äú√ºr√ºn‚Äù aslƒ±nda bir adƒ±m: √∂z√ºr, anlayƒ±≈ü, telafi ve sevgi.
          Hedef tek: <b>Elif‚Äôin y√ºz√ºn√º g√ºld√ºrmek</b>.
        </p>

        <div class="row">
          <button class="btn primary" id="quickAdd">Hƒ±zlƒ± Telafi Seti Ekle</button>
          <button class="btn" id="openCheckout">Checkout (Barƒ±≈ü Teklifi)</button>
          <span class="tiny">ƒ∞pucu: <b>‚ÄúS√ºrpriz‚Äù</b> butonuna bas. üòâ</span>
        </div>

        <div class="divider"></div>
        <div class="row">
          <span class="tag">‚úÖ Yumu≈üak dil</span>
          <span class="tag">‚úÖ Su√ß atmadan</span>
          <span class="tag">‚úÖ Net √∂z√ºr</span>
          <span class="tag">‚úÖ Telafi planƒ±</span>
        </div>
      </div>

      <div class="panel">
        <div class="row" style="justify-content:space-between; align-items:flex-start;">
          <div>
            <h2 style="margin:0 0 6px; letter-spacing:.12em; text-transform:uppercase; font-size:14px;">Canlƒ± Durum</h2>
            <p class="tiny" style="margin:0;">
              <span id="whoText">Sen: -</span>
              ‚Ä¢ <span class="miniLink" id="changeRole">Deƒüi≈ütir</span>
            </p>
          </div>

          <div class="statusLine">
            <span class="tiny" id="lastSeenText">Son bakan: -</span>
            <span class="tiny" id="heartsText">Kalp: 0</span>
          </div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <button class="btn primary" id="btnPeace">Barƒ±≈ü Modu</button>
          <button class="btn danger" id="btnKus">K√ºs Modu</button>
          <span class="tiny" id="modeHint">Modu deƒüi≈ütirebilirsin.</span>
        </div>

        <div class="divider"></div>

        <label>Elif‚Äôe hitap (Emir yazsƒ±n)</label>
        <input id="hitap" value="Elif" />

        <label>Kƒ±sa not (Emir yazsƒ±n)</label>
        <input id="kisaNot" placeholder="√∂rn: Bug√ºn konu≈üup d√ºzeltmek istiyorum." />

        <label>Olu≈üan mesaj (Emir kopyalar)</label>
        <textarea id="mesaj" readonly></textarea>

        <div class="row" style="margin-top:10px; justify-content:space-between;">
          <button class="btn" id="copyBtn">Mesajƒ± Kopyala</button>
          <span class="tiny" id="readText">Okundu: -</span>
        </div>

        <div class="divider"></div>

        <label>Elif‚Äôten not</label>
        <textarea id="elifNote" placeholder="Elif buraya bir not yazabilir‚Ä¶"></textarea>

        <div class="row" style="justify-content:space-between; margin-top:10px;">
          <div class="row">
            <span class="savedBadge wait" id="noteState">Hen√ºz g√∂nderilmedi</span>
          </div>
          <div class="row">
            <button class="btn primary" id="sendNote">G√∂nder</button>
          </div>
        </div>

        <div class="divider"></div>
        <p class="tiny" style="margin:0;">
          Not: Bu sayfa sadece sizde kalacak ≈üekilde tasarlandƒ±. Linki kimseyle payla≈ümayƒ±n.
        </p>
      </div>
    </section>

    <div class="section-title">
      <h2>Koleksiyon</h2>
      <span class="tiny">Arama kutusuyla filtreleyebilirsin.</span>
    </div>

    <section class="grid" id="grid"></section>
  </main>

  <aside class="drawer" id="drawer" aria-hidden="true">
    <div class="drawer-header">
      <h3>G√ñN√úL SEPETƒ∞ (SENKRON)</h3>
      <button class="btn" id="closeDrawer">Kapat</button>
    </div>
    <div class="drawer-body" id="drawerBody"></div>
    <div class="drawer-footer">
      <div class="row" style="justify-content:space-between;">
        <span class="tiny" id="summary">0 √ºr√ºn ‚Ä¢ 0‚Ç∫</span>
        <span class="tiny">‚ÄúFiyat‚Äù = duygusal emek üòÑ</span>
      </div>
      <button class="btn primary" id="checkoutBtn">Checkout ‚Ä¢ Barƒ±≈ü Teklifi</button>
      <button class="btn danger" id="clearBtn">Sepeti Bo≈üalt</button>
    </div>
  </aside>

  <div class="modal" id="modal">
    <div class="modal-card">
      <div class="modal-top">
        <h3>Checkout ‚Ä¢ Barƒ±≈ü Teklifi</h3>
        <button class="btn" id="closeModal">Kapat</button>
      </div>

      <div class="modal-body">
        <div class="box">
          <h4 style="margin:0 0 10px;">üéÅ Barƒ±≈ü Planƒ±</h4>
          <p class="tiny" style="line-height:1.6;margin:0;">
            1) Kƒ±sa ve net √∂z√ºr <br/>
            2) Onu anladƒ±ƒüƒ±nƒ± s√∂yle <br/>
            3) Telafi √∂ner (somut) <br/>
            4) ‚ÄúKonu≈üalƒ±m‚Äù ama baskƒ± yapmadan
          </p>

          <div class="divider"></div>

          <label>Telafi √∂nerin (Emir)</label>
          <input id="telafi" placeholder="√∂rn: Yarƒ±n kahve + y√ºr√ºy√º≈ü, sen ne istersen." />

          <label>√ñz√ºr c√ºmlen (Emir)</label>
          <input id="ozur" placeholder="√∂rn: Seni √ºzd√ºysem ger√ßekten √∂z√ºr dilerim." />

          <label>Son mesaj (kopyalanabilir)</label>
          <textarea id="finalMsg" readonly></textarea>

          <div class="row" style="margin-top:10px; justify-content:space-between;">
            <button class="btn" id="copyFinal">Finali Kopyala</button>
            <button class="btn primary" id="sendLove">Kalp G√∂nder</button>
          </div>
        </div>

        <div class="box">
          <h4 style="margin:0 0 10px;">üñ§ Elif‚Äôe √ñzel</h4>
          <p class="tiny" style="line-height:1.6;margin:0 0 10px;">
            Metni ki≈üiselle≈ütir. ‚ÄúBen‚Äù dili kullan, ‚Äúsen hep‚Äù deme.
          </p>
          <div class="divider"></div>

          <label>Onu en √ßok sevdiƒüin ≈üey (Emir)</label>
          <input id="sevgi" placeholder="√∂rn: Senin yanƒ±nda huzurluyum." />

          <label>ƒ∞leti≈üim c√ºmlesi (Emir)</label>
          <input id="iletisim" value="Konu≈ümak istersen ben buradayƒ±m." />

          <label>Kapanƒ±≈ü (Emir)</label>
          <input id="kapanis" value="Seni √∂nemsiyorum. ‚ù§Ô∏è" />

          <div class="divider"></div>

          <button class="btn" id="autoFill">Otomatik Doldur (≈ûƒ±k)</button>
          <p class="tiny" style="margin:10px 0 0;">
            Bu metin iskelet. En iyisi senin dilinle k√º√ß√ºk dokunu≈ü.
          </p>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn" id="closeModal2">Kapat</button>
        <button class="btn primary" id="finishBtn">Barƒ±≈üa Bir Adƒ±m Daha</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Kopyalandƒ± ‚úÖ</div>

  <!-- Role chooser overlay -->
  <div class="roleOverlay" id="roleOverlay">
    <div class="roleCard">
      <h3>Sen kimsin?</h3>
      <p class="tiny" style="margin:0;">
        Bu se√ßim sadece senin cihazƒ±nda hatƒ±rlanƒ±r. Sonradan ‚ÄúDeƒüi≈ütir‚Äù diyebilirsin.
      </p>
      <div class="roleGrid">
        <button class="roleBtn" id="pickEmir">
          <b>Ben Emir‚Äôim</b>
          <span>Mesajlarƒ± d√ºzenler, durumu g√∂r√ºr.</span>
        </button>
        <button class="roleBtn" id="pickElif">
          <b>Ben Elif‚Äôim</b>
          <span>Not yazabilir, modu & sepeti deƒüi≈ütirebilir.</span>
        </button>
      </div>
    </div>
  </div>

  <footer>
    <span>¬© ELIF BEAUTY ‚Ä¢ G√∂n√ºl Onarƒ±m Maƒüazasƒ±</span>
    <span class="tiny">Easter egg: ‚ÄúS√ºrpriz‚Äùe 3 kez bas üòâ</span>
  </footer>

  <!-- =========================
       FIREBASE (CANLI SENKRON)
       ========================= -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, increment } from
      "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // ‚úÖ BURAYI DOLDUR (Firebase Config)
    const firebaseConfig = {
      apiKey: "AIzaSyAYOjXNc0vfzNL68z4pmbX8kFoQSC11LZ8",
  authDomain: "elif-site.firebaseapp.com",
  projectId: "elif-site",
  storageBucket: "elif-site.firebasestorage.app",
  messagingSenderId: "740065601752",
  appId: "1:740065601752:web:38898a11ab28cba588cfad",
  measurementId: "G-53C6DN719D"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const stateRef = doc(db, "shared", "relationshipState");

    function nowTs(){ return Date.now(); }

    async function ensureDefaults(){
      const snap = await getDoc(stateRef);
      if(!snap.exists()){
        await setDoc(stateRef, {
          peaceMode: false,
          elifNote: "",
          elifNoteUpdatedAt: 0,
          cart: [],
          hearts: 0,
          reads: {},    // { Emir: ts, Elif: ts }
          lastSeen: {}  // { name, ts }
        });
      }
    }

    // pingSeen debounce (spam engeli)
    let lastPingAt = 0;
    async function pingSeenDebounced(name){
      const now = nowTs();
      if (now - lastPingAt < 5000) return; // 5 sn‚Äôde 1
      lastPingAt = now;
      await updateDoc(stateRef, { lastSeen: { name, ts: now } });
    }

    window.__sharedState = {
      viewerName: localStorage.getItem("viewerName") || "",

      setViewer(name){
        this.viewerName = name;
        localStorage.setItem("viewerName", name);
      },

      async init(handlers){
        await ensureDefaults();
        if (this.viewerName) await pingSeenDebounced(this.viewerName);

        onSnapshot(stateRef, (s)=>{
          if(!s.exists()) return;
          const d = s.data();

          handlers?.onPeaceMode?.(!!d.peaceMode);
          handlers?.onElifNote?.(typeof d.elifNote === "string" ? d.elifNote : "", d.elifNoteUpdatedAt || 0);
          handlers?.onCart?.(Array.isArray(d.cart) ? d.cart : []);
          handlers?.onHearts?.(typeof d.hearts === "number" ? d.hearts : 0);
          handlers?.onReads?.(d.reads || {});
          handlers?.onLastSeen?.(d.lastSeen || {});
        });
      },

      async setPeaceMode(on){
        await updateDoc(stateRef, { peaceMode: !!on });
        if (this.viewerName) await pingSeenDebounced(this.viewerName);
      },

      async setElifNote(text){
        await updateDoc(stateRef, { elifNote: String(text ?? ""), elifNoteUpdatedAt: nowTs() });
        if (this.viewerName) await pingSeenDebounced(this.viewerName);
      },

      async setCart(cartIds){
        await updateDoc(stateRef, { cart: cartIds });
        if (this.viewerName) await pingSeenDebounced(this.viewerName);
      },

      async addHearts(n=1){
        await updateDoc(stateRef, { hearts: increment(n) });
        if (this.viewerName) await pingSeenDebounced(this.viewerName);
      },

      async markRead(){
        if(!this.viewerName) return;
        await updateDoc(stateRef, { [`reads.${this.viewerName}`]: nowTs() });
        await pingSeenDebounced(this.viewerName);
      },

      async pingSeen(){
        if(!this.viewerName) return;
        await pingSeenDebounced(this.viewerName);
      }
    };
  </script>

  <!-- =========================
       APP SCRIPT
       ========================= -->
  <script>
    const products = [
      { id:"p1", icon:"ü§ç", name:"Net √ñz√ºr Serum", price: 49, tag:"Best Seller",
        desc:"Savunmaya ge√ßmeden, kƒ±sa ve net bir √∂z√ºr: kalbi yormaz, duvarlarƒ± indirir." },
      { id:"p2", icon:"üß†", name:"Anlayƒ±≈ü Tonik", price: 39, tag:"Gentle",
        desc:"‚ÄòSeni anlƒ±yorum‚Äô kƒ±smƒ±nƒ± doƒüru kurar. Haklƒ±lƒ±k kavgasƒ±nƒ± bitirir." },
      { id:"p3", icon:"ü´∂", name:"Sarƒ±lma Kremi", price: 59, tag:"Hydrating",
        desc:"Sƒ±cak, g√ºven veren bir yakla≈üƒ±m. Buzlarƒ± yava≈ü yava≈ü eritir." },
      { id:"p4", icon:"‚òï", name:"Kahve + Y√ºr√ºy√º≈ü Set", price: 89, tag:"Classic",
        desc:"Somut telafi √∂nerisi. ‚ÄòKonu≈üalƒ±m mƒ±?‚Äônƒ±n en zarif hali." },
      { id:"p5", icon:"üìù", name:"Tek C√ºmlelik ƒ∞tiraf Lip", price: 29, tag:"Minimal",
        desc:"‚ÄòSeni kƒ±rdƒ±ysam ger√ßekten √ºzg√ºn√ºm.‚Äô gibi tek c√ºmleyle etkili vuru≈ü." },
      { id:"p6", icon:"üå∏", name:"Tatlƒ± Hatƒ±ra Parf√ºm", price: 99, tag:"Signature",
        desc:"ƒ∞kinizi g√ºl√ºmseten bir anƒ±yƒ± hatƒ±rlatƒ±r. Atmosferi yumu≈üatƒ±r." },
      { id:"p7", icon:"üéß", name:"Dinleme Maskesi", price: 69, tag:"Deep Care",
        desc:"S√∂z√ºn√º kesmeden dinleme modu. ‚Äò√ñnce seni anlayayƒ±m‚Äô enerjisi." },
      { id:"p8", icon:"üìµ", name:"Baskƒ±sƒ±z Alan SPF", price: 44, tag:"Respect",
        desc:"√úst √ºste mesaj atma korumasƒ±. Alan tanƒ±r, saygƒ± g√∂sterir." },
      { id:"p9", icon:"üéÅ", name:"K√º√ß√ºk S√ºrpriz Mini", price: 79, tag:"Cute",
        desc:"Abartmadan, d√º≈ü√ºnceli bir jest. ‚ÄòSeni √∂nemsiyorum‚Äô der." },
    ];

    // Elements
    const grid = document.getElementById("grid");
    const q = document.getElementById("q");

    const drawer = document.getElementById("drawer");
    const cartBtn = document.getElementById("cartBtn");
    const closeDrawer = document.getElementById("closeDrawer");
    const drawerBody = document.getElementById("drawerBody");
    const cartCount = document.getElementById("cartCount");
    const summary = document.getElementById("summary");
    const clearBtn = document.getElementById("clearBtn");
    const checkoutBtn = document.getElementById("checkoutBtn");

    const statusText = document.getElementById("statusText");
    const dot = document.getElementById("dot");
    const statusPill = document.getElementById("statusPill");

    const surpriseBtn = document.getElementById("surpriseBtn");
    const quickAdd = document.getElementById("quickAdd");

    const hitap = document.getElementById("hitap");
    const kisaNot = document.getElementById("kisaNot");
    const mesaj = document.getElementById("mesaj");
    const copyBtn = document.getElementById("copyBtn");

    const readText = document.getElementById("readText");
    const heartsText = document.getElementById("heartsText");
    const lastSeenText = document.getElementById("lastSeenText");

    const btnPeace = document.getElementById("btnPeace");
    const btnKus = document.getElementById("btnKus");
    const modeHint = document.getElementById("modeHint");

    const elifNoteEl = document.getElementById("elifNote");
    const sendNote = document.getElementById("sendNote");
    const noteState = document.getElementById("noteState");

    const whoText = document.getElementById("whoText");
    const changeRole = document.getElementById("changeRole");

    const modal = document.getElementById("modal");
    const openCheckout = document.getElementById("openCheckout");
    const closeModal = document.getElementById("closeModal");
    const closeModal2 = document.getElementById("closeModal2");
    const telafi = document.getElementById("telafi");
    const ozur = document.getElementById("ozur");
    const sevgi = document.getElementById("sevgi");
    const iletisim = document.getElementById("iletisim");
    const kapanis = document.getElementById("kapanis");
    const finalMsg = document.getElementById("finalMsg");
    const copyFinal = document.getElementById("copyFinal");
    const sendLove = document.getElementById("sendLove");
    const autoFill = document.getElementById("autoFill");
    const finishBtn = document.getElementById("finishBtn");

    const toast = document.getElementById("toast");

    // Role overlay
    const roleOverlay = document.getElementById("roleOverlay");
    const pickEmir = document.getElementById("pickEmir");
    const pickElif = document.getElementById("pickElif");

    // State
    let cart = [];
    let surpriseCount = 0;
    let peaceMode = false;

    let suppressCartWrite = false;
    let suppressNoteWrite = false;

    // Permissions: only Elif can change mode, note, cart (Emir sadece izler + mesajƒ± kopyalar)
    function isElif(){ return (window.__sharedState?.viewerName || "") === "Elif"; }
    function viewer(){ return (window.__sharedState?.viewerName || ""); }

    function enforcePermissions(){
      const elif = isElif();
      whoText.textContent = `Sen: ${viewer() || "-"}`;

      // Elif yetkileri
      btnPeace.disabled = !elif;
      btnKus.disabled = !elif;
      clearBtn.disabled = !elif;

      elifNoteEl.readOnly = !elif;
      sendNote.disabled = !elif;

      // √úr√ºn ekleme butonlarƒ±
      document.querySelectorAll(".add").forEach(b => b.disabled = !elif);
      // Sepet i√ßi silme butonlarƒ±
      document.querySelectorAll(".remove").forEach(b => b.disabled = !elif);

      modeHint.textContent = elif
        ? "Modu deƒüi≈ütirebilirsin."
        : "Modu sadece Elif deƒüi≈ütirebilir.";

      // Emir mesaj alanƒ±: zaten readonly
    }

    function money(n){ return `${n}‚Ç∫`; }

    function renderCards(list){
      grid.innerHTML = "";
      list.forEach(p=>{
        const el = document.createElement("div");
        el.className = "card";
        el.innerHTML = `
          <div class="thumb"><span>${p.icon}</span></div>
          <div class="meta">
            <p class="name">${p.name}</p>
            <p class="desc">${p.desc}</p>
            <div class="price">
              <span class="tag">${p.tag} ‚Ä¢ ${money(p.price)}</span>
              <button class="add" data-id="${p.id}">G√∂nl√ºne Ekle</button>
            </div>
          </div>
        `;
        grid.appendChild(el);
      });

      grid.querySelectorAll(".add").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          if(!isElif()) return;
          addToCart(btn.dataset.id);
        });
      });

      enforcePermissions();
    }

    function cartIds(){ return cart.map(p => p.id); }

    function addToCart(id){
      const p = products.find(x=>x.id===id);
      if(!p) return;
      cart.push(p);
      popToast(`Eklendi: ${p.name}`);
      burstHearts(6);
      updateCartUI();
      updateMessage();

      if (!suppressCartWrite && window.__sharedState) {
        window.__sharedState.setCart(cartIds());
      }
    }

    function removeFromCart(idx){
      if(!isElif()) return;
      cart.splice(idx, 1);
      updateCartUI();
      updateMessage();

      if (!suppressCartWrite && window.__sharedState) {
        window.__sharedState.setCart(cartIds());
      }
    }

    function applyRemoteCart(ids){
      suppressCartWrite = true;
      cart = ids.map(id => products.find(p => p.id === id)).filter(Boolean);
      updateCartUI();
      updateMessage();
      suppressCartWrite = false;
    }

    function updateCartUI(){
      cartCount.textContent = cart.length;
      drawerBody.innerHTML = "";

      if(cart.length === 0){
        drawerBody.innerHTML = `<p class="tiny">Sepet bo≈ü. Elif‚Äôin g√∂nl√ºne gidecek birka√ß ≈üey se√ß üòâ</p>`;
        summary.textContent = `0 √ºr√ºn ‚Ä¢ 0‚Ç∫`;
        enforcePermissions();
        return;
      }

      const total = cart.reduce((a,b)=>a+b.price,0);
      summary.textContent = `${cart.length} √ºr√ºn ‚Ä¢ ${money(total)}`;

      cart.forEach((p, idx)=>{
        const it = document.createElement("div");
        it.className="item";
        it.innerHTML = `
          <div class="thumb"><span>${p.icon}</span></div>
          <div style="flex:1">
            <p class="name">${p.name}</p>
            <p class="desc">${p.tag} ‚Ä¢ ${money(p.price)}</p>
          </div>
          <button class="remove" data-idx="${idx}">Sil</button>
        `;
        drawerBody.appendChild(it);
      });

      drawerBody.querySelectorAll(".remove").forEach(btn=>{
        btn.addEventListener("click", ()=> removeFromCart(Number(btn.dataset.idx)));
      });

      enforcePermissions();
    }

    function buildMessage(){
      const H = (hitap.value || "Elif").trim();
      const note = (kisaNot.value || "").trim();

      const picks = cart.map(p=>p.name);
      const has = (name)=> picks.some(x=>x.toLowerCase().includes(name.toLowerCase()));

      const parts = [];
      parts.push(`${H}, sana yazmadan i√ßim rahat etmedi.`);

      if(has("√ñz√ºr") || has("ƒ∞tiraf")){
        parts.push(`Seni kƒ±rdƒ±ysam ger√ßekten √∂z√ºr dilerim. Savunmaya ge√ßmek istemiyorum.`);
      } else {
        parts.push(`Seni √ºzd√ºƒü√ºm√º hissediyorum ve bunun i√ßin √ºzg√ºn√ºm.`);
      }

      if(has("Anlayƒ±≈ü") || has("Dinleme")){
        parts.push(`Seni dinlemek ve ger√ßekten anlamak istiyorum. Haklƒ± olduƒüun yerler varsa kabul ediyorum.`);
      } else {
        parts.push(`√ñnemli olan haklƒ±lƒ±k deƒüil; aramƒ±zƒ±n iyi olmasƒ±.`);
      }

      if(has("Kahve") || has("S√ºrpriz")){
        parts.push(`ƒ∞stersen bir kahve i√ßip kƒ±sa bir y√ºr√ºy√º≈ü yapalƒ±m; sen nasƒ±l istersen. Ben telafi etmek istiyorum.`);
      } else {
        parts.push(`Konu≈üup sakin sakin d√ºzeltmek istiyorum.`);
      }

      if(note) parts.push(note);
      parts.push(`Beni istersen sonra da dinleyebilirsin; acele ettirmeyeceƒüim. Seni √∂nemsiyorum. ü§ç`);
      return parts.join("\n\n");
    }

    function updateMessage(){
      mesaj.value = buildMessage();
      updateFinalMsg();
    }

    function renderPeaceUI(on){
      peaceMode = on;
      if(on){
        statusText.textContent = "Barƒ±≈ü Modu";
        dot.classList.add("ok");
        statusPill.style.borderColor = "rgba(85,214,167,.35)";
      } else {
        statusText.textContent = "K√ºs Modu";
        dot.classList.remove("ok");
        statusPill.style.borderColor = "rgba(255,255,255,.12)";
      }
    }

    async function setPeaceModeShared(on){
      renderPeaceUI(on);
      if (window.__sharedState && isElif()) {
        await window.__sharedState.setPeaceMode(on);
      }
    }

    function openDrawer(){ drawer.classList.add("open"); drawer.setAttribute("aria-hidden","false"); }
    function closeDrawerFn(){ drawer.classList.remove("open"); drawer.setAttribute("aria-hidden","true"); }

    function openModal(){
      modal.classList.add("open");
      updateFinalMsg();
    }
    function closeModalFn(){ modal.classList.remove("open"); }

    function popToast(text="Kopyalandƒ± ‚úÖ"){
      toast.textContent = text;
      toast.classList.add("show");
      setTimeout(()=>toast.classList.remove("show"), 1100);
    }

    function copyText(str){
      navigator.clipboard.writeText(str)
        .then(()=>popToast("Kopyalandƒ± ‚úÖ"))
        .catch(()=>popToast("Kopyalanamadƒ± ‚ùå"));
    }

    function heart(x,y,emoji="‚ù§Ô∏è"){
      const h = document.createElement("div");
      h.className = "heart";
      h.textContent = emoji;
      h.style.left = x + "px";
      h.style.top = y + "px";
      document.body.appendChild(h);
      setTimeout(()=>h.remove(), 1300);
    }

    function burstHearts(n=8){
      const cx = window.innerWidth - 70;
      const cy = 90;
      for(let i=0;i<n;i++){
        const x = cx + (Math.random()*40 - 20);
        const y = cy + (Math.random()*30 - 15);
        setTimeout(()=>heart(x,y, Math.random()>.25?"‚ù§Ô∏è":"ü§ç"), i*35);
      }
    }

    function rainHearts(count=28){
      for(let i=0;i<count;i++){
        setTimeout(()=>{
          const x = Math.random() * window.innerWidth;
          const y = window.innerHeight - 40;
          const h = document.createElement("div");
          h.className="heart";
          h.textContent = Math.random()>.25 ? "‚ù§Ô∏è" : "ü§ç";
          h.style.left = x + "px";
          h.style.top = y + "px";
          h.style.animationDuration = (0.9 + Math.random()*0.9) + "s";
          document.body.appendChild(h);
          setTimeout(()=>h.remove(), 1600);
        }, i*40);
      }
    }

    function updateFinalMsg(){
      const H = (hitap.value || "Elif").trim();
      const oz = (ozur.value || "").trim();
      const tl = (telafi.value || "").trim();
      const sv = (sevgi.value || "").trim();
      const il = (iletisim.value || "Konu≈ümak istersen ben buradayƒ±m.").trim();
      const kp = (kapanis.value || "Seni √∂nemsiyorum. ‚ù§Ô∏è").trim();

      const base = [];
      base.push(`${H},`);
      base.push(oz || `Seni kƒ±rdƒ±ysam ger√ßekten √∂z√ºr dilerim. Amacƒ±m asla seni √ºzmek deƒüildi.`);
      if(sv) base.push(sv);
      base.push(tl || `ƒ∞stersen uygun olduƒüunda konu≈üalƒ±m; ben telafi etmek istiyorum.`);
      base.push(il);
      base.push(kp);

      finalMsg.value = base.join("\n\n");
    }

    // Note saved UI
    function setNoteState(state){
      // state: "idle" | "dirty" | "saved"
      if(state === "dirty"){
        noteState.className = "savedBadge wait";
        noteState.textContent = "Yazƒ±lƒ±yor‚Ä¶";
      } else if(state === "saved"){
        noteState.className = "savedBadge ok";
        noteState.textContent = "G√∂nderildi ‚úÖ";
      } else {
        noteState.className = "savedBadge wait";
        noteState.textContent = "Hen√ºz g√∂nderilmedi";
      }
    }

    // Role overlay helpers
    function openRoleOverlay(){ roleOverlay.classList.add("open"); }
    function closeRoleOverlay(){ roleOverlay.classList.remove("open"); }

    async function setRole(name){
      window.__sharedState?.setViewer(name);
      enforcePermissions();
      closeRoleOverlay();

      // okundu + seen
      if(window.__sharedState){
        await window.__sharedState.markRead();
        await window.__sharedState.pingSeen();
      }
    }

    // ===== Events =====
    cartBtn.addEventListener("click", openDrawer);
    closeDrawer.addEventListener("click", closeDrawerFn);

    clearBtn.addEventListener("click", ()=>{
      if(!isElif()) return;
      cart = [];
      updateCartUI();
      updateMessage();
      popToast("Sepet bo≈üaltƒ±ldƒ±");
      if (window.__sharedState) window.__sharedState.setCart([]);
    });

    checkoutBtn.addEventListener("click", openModal);
    openCheckout.addEventListener("click", openModal);

    closeModal.addEventListener("click", closeModalFn);
    closeModal2.addEventListener("click", closeModalFn);

    copyBtn.addEventListener("click", ()=> copyText(mesaj.value));
    copyFinal.addEventListener("click", ()=> copyText(finalMsg.value));

    sendLove.addEventListener("click", async ()=>{
      burstHearts(14);
      rainHearts(22);
      popToast("Kalpler yolda üíå");
      if (window.__sharedState) await window.__sharedState.addHearts(1);
    });

    autoFill.addEventListener("click", ()=>{
      ozur.value = "Seni √ºzd√ºysem ger√ßekten √∂z√ºr dilerim. Savunmaya ge√ßmek istemiyorum.";
      telafi.value = "ƒ∞stersen bir kahve i√ßip kƒ±sa bir y√ºr√ºy√º≈ü yapalƒ±m; sen ne istersen.";
      sevgi.value = "Senin yanƒ±nda kendimi iyi ve huzurlu hissediyorum, bunu kaybetmek istemem.";
      iletisim.value = "Konu≈ümak istersen ben buradayƒ±m, seni zorlamayacaƒüƒ±m.";
      kapanis.value = "Seni √∂nemsiyorum. ü§ç";
      updateFinalMsg();
      popToast("≈ûƒ±k metin hazƒ±r ‚ú®");
    });

    finishBtn.addEventListener("click", ()=>{
      rainHearts(30);
      popToast("Barƒ±≈üa bir adƒ±m daha ‚ú®");
    });

    btnPeace.addEventListener("click", async ()=>{
      if(!isElif()) return;
      await setPeaceModeShared(true);
      burstHearts(10);
      popToast("Barƒ±≈ü Modu ‚úÖ");
    });

    btnKus.addEventListener("click", async ()=>{
      if(!isElif()) return;
      await setPeaceModeShared(false);
      popToast("K√ºs Modu ‚úÖ");
    });

    surpriseBtn.addEventListener("click", ()=>{
      surpriseCount++;
      burstHearts(10);
      popToast("S√ºrpriz a√ßƒ±ldƒ± ‚ú®");
      if(surpriseCount >= 3){
        rainHearts(40);
        popToast("Easter egg! ‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è");
        surpriseCount = 0;
      }
    });

    quickAdd.addEventListener("click", ()=>{
      if(!isElif()) { popToast("Bu seti Elif se√ßebilir ‚ú®"); openDrawer(); return; }
      ["p1","p2","p4","p7","p8"].forEach(addToCart);
      openDrawer();
    });

    q.addEventListener("keydown", (e)=>{
      if(e.key === "Enter"){
        const term = q.value.trim().toLowerCase();
        const filtered = !term ? products : products.filter(p =>
          (p.name + " " + p.desc + " " + p.tag).toLowerCase().includes(term)
        );
        renderCards(filtered);
        popToast(filtered.length ? `${filtered.length} sonu√ß` : "Sonu√ß yok");
      }
    });

    [hitap, kisaNot].forEach(el=> el.addEventListener("input", updateMessage));
    [telafi, ozur, sevgi, iletisim, kapanis].forEach(el=> el.addEventListener("input", updateFinalMsg));

    document.addEventListener("keydown", (e)=>{
      if(e.key === "Escape"){
        closeDrawerFn();
        closeModalFn();
      }
    });

    // Role overlay triggers
    changeRole.addEventListener("click", openRoleOverlay);
    pickEmir.addEventListener("click", ()=> setRole("Emir"));
    pickElif.addEventListener("click", ()=> setRole("Elif"));

    // Note behavior: only Elif can type, and needs "G√∂nder"
    let localNoteDirty = false;
    let noteTypingTimer = null;

    elifNoteEl.addEventListener("input", ()=>{
      if(!isElif()) return;
      localNoteDirty = true;
      setNoteState("dirty");
      clearTimeout(noteTypingTimer);
      noteTypingTimer = setTimeout(()=> {
        // yazmayƒ± bitirdi -> "G√∂nder"e basmasƒ±nƒ± bekle
        setNoteState("idle");
      }, 450);
    });

    sendNote.addEventListener("click", async ()=>{
      if(!isElif()) return;
      if(!window.__sharedState) return;

      const text = elifNoteEl.value;
      setNoteState("dirty");
      await window.__sharedState.setElifNote(text);
      localNoteDirty = false;
      setNoteState("saved");
      popToast("Not g√∂nderildi ‚úÖ");
    });

    // Read status: daha doƒüru
    async function markReadSmart(){
      if(!window.__sharedState) return;
      if(!viewer()) return;
      await window.__sharedState.markRead();
    }
    // sayfa a√ßƒ±lƒ±nca
    window.addEventListener("load", ()=> markReadSmart());
    // sekmeye geri d√∂n√ºnce
    document.addEventListener("visibilitychange", ()=>{
      if(document.visibilityState === "visible") markReadSmart();
    });
    // sayfa odaklanƒ±nca
    window.addEventListener("focus", ()=> markReadSmart());

    // Init UI
    renderCards(products);
    updateCartUI();
    updateMessage();
    renderPeaceUI(false);
    setNoteState("idle");

    // If no role selected on this device -> show overlay
    if(!window.__sharedState?.viewerName){
      openRoleOverlay();
    } else {
      enforcePermissions();
    }

    // Firebase live
    (async ()=>{
      if (!window.__sharedState) return;

      await window.__sharedState.init({
        onPeaceMode: (v)=> renderPeaceUI(v),

        onElifNote: (text, updatedAt)=> {
          // Remote note geldiƒüinde sadece Elif yazƒ±yorsa ve local deƒüi≈üiklik varsa ezmeyelim
          if(isElif() && localNoteDirty) return;

          suppressNoteWrite = true;
          if (elifNoteEl.value !== text) elifNoteEl.value = text;
          suppressNoteWrite = false;

          // Notun varlƒ±ƒüƒ±na g√∂re badge
          if(text && updatedAt){
            setNoteState("saved");
          } else {
            setNoteState("idle");
          }
        },

        onCart: (ids)=> {
          const local = cartIds();
          const same = local.length === ids.length && local.every((x,i)=>x===ids[i]);
          if (!same) applyRemoteCart(ids);
        },

        onHearts: (n)=> { heartsText.textContent = `Kalp: ${n}`; },

        onReads: (reads)=> {
          const fmt = (ts)=> ts ? new Date(ts).toLocaleString("tr-TR") : "-";
          readText.textContent = `Okundu ‚Ä¢ Emir: ${fmt(reads?.Emir)} ‚Ä¢ Elif: ${fmt(reads?.Elif)}`;
        },

        onLastSeen: (ls)=> {
          if(!ls?.name || !ls?.ts) { lastSeenText.textContent = "Son bakan: -"; return; }
          lastSeenText.textContent = `Son bakan: ${ls.name} ‚Ä¢ ${new Date(ls.ts).toLocaleString("tr-TR")}`;
        }
      });

      // role se√ßiliyse yetkileri uygula
      enforcePermissions();

      // a√ßƒ±lƒ±≈üta seen + read
      await window.__sharedState.pingSeen();
      await window.__sharedState.markRead();
    })();
  </script>
</body>
</html>
